# Docker ä»£ç æ›´æ–°æŒ‡å—

## ğŸ“‹ é—®é¢˜è¯´æ˜

å½“ä½¿ç”¨ `docker-compose up -d` å¯åŠ¨å®¹å™¨æ—¶ï¼Œå¦‚æœæœ¬åœ°ä»£ç å·²æ›´æ–°ä½†å®¹å™¨ä¸­çš„ä»£ç æ²¡æœ‰æ›´æ–°ï¼ŒåŸå› æ˜¯ï¼š

**Dockerfile ä½¿ç”¨äº† COPY æ–¹å¼å¤åˆ¶ä»£ç åˆ°é•œåƒä¸­**ï¼Œä»£ç è¢«å›ºåŒ–åœ¨é•œåƒå†…éƒ¨ï¼Œå¿…é¡»é‡æ–°æ„å»ºé•œåƒæ‰èƒ½ä½¿ç”¨æ–°ä»£ç ã€‚

## ğŸš€ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå®Œæ•´æ›´æ–°ï¼ˆæ¨èï¼Œç¡®ä¿å®Œå…¨ä½¿ç”¨æ–°ä»£ç ï¼‰

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# 1. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
docker-compose down

# 2. é‡æ–°æ„å»ºé•œåƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
docker-compose build --no-cache

# 3. å¯åŠ¨æ–°å®¹å™¨
docker-compose up -d

# 4. æŸ¥çœ‹æ—¥å¿—éªŒè¯
docker-compose logs -f
```

**æˆ–ä½¿ç”¨æä¾›çš„è„šæœ¬ï¼š**

```bash
# Linux/Mac
chmod +x update_docker.sh
./update_docker.sh

# Windows
update_docker.bat
```

### æ–¹æ¡ˆäºŒï¼šå¿«é€Ÿæ›´æ–°ï¼ˆä½¿ç”¨ç¼“å­˜ï¼Œé€Ÿåº¦æ›´å¿«ï¼‰

```bash
# åœæ­¢æ—§å®¹å™¨
docker-compose down

# é‡æ–°æ„å»ºï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
docker-compose build

# å¯åŠ¨æ–°å®¹å™¨
docker-compose up -d
```

**æˆ–ä½¿ç”¨å¿«é€Ÿè„šæœ¬ï¼š**

```bash
chmod +x update_docker_quick.sh
./update_docker_quick.sh
```

## ğŸ” éªŒè¯æ›´æ–°

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
docker-compose ps
```

åº”è¯¥çœ‹åˆ°å®¹å™¨çŠ¶æ€ä¸º `Up` æˆ– `running`ã€‚

### 2. æŸ¥çœ‹å®¹å™¨æ—¥å¿—

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹æœ€è¿‘50è¡Œæ—¥å¿—
docker-compose logs --tail=50
```

åœ¨æ—¥å¿—ä¸­åº”è¯¥èƒ½çœ‹åˆ°æ–°çš„æ—¥å¿—è¾“å‡ºï¼Œæ¯”å¦‚åˆ†æ‰¹åŠ è½½è´¦æˆ·çš„æ—¥å¿—ï¼š
```
Starting scheduled token refresh for all accounts...
Loaded 1000 accounts from page 1, total loaded: 1000/3500
Loaded 1000 accounts from page 2, total loaded: 2000/3500
...
```

### 3. è¿›å…¥å®¹å™¨éªŒè¯ä»£ç 

```bash
# è¿›å…¥å®¹å™¨
docker exec -it outlook-email-api /bin/sh

# æŸ¥çœ‹ main.py çš„ä¿®æ”¹æ—¶é—´
ls -lh main.py

# æ£€æŸ¥ä»£ç å†…å®¹ï¼ˆæŸ¥çœ‹æ˜¯å¦åŒ…å«æ–°çš„åˆ†æ‰¹é€»è¾‘ï¼‰
grep -A 5 "åˆ†æ‰¹è·å–æ‰€æœ‰è´¦æˆ·" main.py

# é€€å‡ºå®¹å™¨
exit
```

### 4. æµ‹è¯•åŠŸèƒ½

1. æµè§ˆå™¨è®¿é—®ï¼š`http://æœåŠ¡å™¨IP:8001`
2. ç™»å½•åå°ç®¡ç†ç³»ç»Ÿ
3. è¿›å…¥è´¦æˆ·ç®¡ç†é¡µé¢
4. ç‚¹å‡»"æ‰¹é‡åˆ·æ–°Token"æŒ‰é’®
5. æ£€æŸ¥æ˜¯å¦æœ‰ç¡®è®¤å¯¹è¯æ¡†å¼¹å‡º
6. æŸ¥çœ‹æµè§ˆå™¨å¼€å‘è€…å·¥å…· Network æ ‡ç­¾ï¼Œç¡®è®¤è¯·æ±‚å·²å‘é€

## ğŸ› ï¸ å¸¸ç”¨ Docker å‘½ä»¤

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs -f

# é‡å¯å®¹å™¨ï¼ˆä¸é‡æ–°æ„å»ºï¼‰
docker-compose restart

# åœæ­¢å®¹å™¨
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# æŸ¥çœ‹é•œåƒ
docker images | grep outlook

# åˆ é™¤æ—§é•œåƒ
docker rmi <é•œåƒID>

# æ¸…ç†æœªä½¿ç”¨çš„é•œåƒå’Œå®¹å™¨ï¼ˆé‡Šæ”¾ç©ºé—´ï¼‰
docker system prune -a

# è¿›å…¥å®¹å™¨
docker exec -it outlook-email-api /bin/sh

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats outlook-email-api
```

## ğŸ“ æ›´æ–°æ­¥éª¤è¯¦è§£

### ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°æ„å»ºï¼Ÿ

æŸ¥çœ‹ `docker/Dockerfile` ç¬¬24-42è¡Œï¼š

```dockerfile
# å¤åˆ¶åº”ç”¨ä»£ç 
COPY main.py .
COPY config.py .
COPY database.py .
COPY routes/ ./routes/
COPY static/ ./static/
...
```

è¿™äº› COPY æŒ‡ä»¤åœ¨**æ„å»ºé•œåƒæ—¶**æ‰§è¡Œä¸€æ¬¡ï¼Œå°†ä»£ç å¤åˆ¶åˆ°é•œåƒå†…éƒ¨ã€‚ä¹‹åå³ä½¿æœ¬åœ°ä»£ç ä¿®æ”¹äº†ï¼Œå®¹å™¨å†…çš„ä»£ç ä»ç„¶æ˜¯æ„å»ºæ—¶çš„ç‰ˆæœ¬ã€‚

### `docker-compose up -d` ä¸ºä»€ä¹ˆä¸æ›´æ–°ä»£ç ï¼Ÿ

- `docker-compose up -d`ï¼šåªå¯åŠ¨å®¹å™¨ï¼Œå¦‚æœé•œåƒå·²å­˜åœ¨ï¼Œç›´æ¥ä½¿ç”¨ç°æœ‰é•œåƒ
- ä¸ä¼šè‡ªåŠ¨æ£€æµ‹ä»£ç å˜åŒ–
- ä¸ä¼šé‡æ–°æ„å»ºé•œåƒ

### `docker-compose build` åšäº†ä»€ä¹ˆï¼Ÿ

- é‡æ–°æ‰§è¡Œ Dockerfile ä¸­çš„æ‰€æœ‰æŒ‡ä»¤
- é‡æ–° COPY ä»£ç æ–‡ä»¶åˆ°é•œåƒ
- åˆ›å»ºæ–°çš„é•œåƒå±‚

### `--no-cache` å‚æ•°çš„ä½œç”¨

- ä¸ä½¿ç”¨ Docker æ„å»ºç¼“å­˜
- å¼ºåˆ¶é‡æ–°æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
- ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ä»£ç å’Œä¾èµ–
- æ„å»ºæ—¶é—´æ›´é•¿ï¼Œä½†ç»“æœæ›´å¯é 

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒ

å¦‚æœç»å¸¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ volume æŒ‚è½½ä»£ç ï¼š

ä¿®æ”¹ `docker-compose.yml`ï¼Œæ·»åŠ ä»£ç volumeï¼š

```yaml
volumes:
  - ./data.db:/app/data.db
  - ./logs:/app/logs
  # æŒ‚è½½ä»£ç ç›®å½•ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  - ./main.py:/app/main.py
  - ./static:/app/static
  - ./routes:/app/routes
  # ... å…¶ä»–ä»£ç æ–‡ä»¶
```

**ä¼˜ç‚¹ï¼š** ä¿®æ”¹ä»£ç ååªéœ€é‡å¯å®¹å™¨ `docker-compose restart`
**ç¼ºç‚¹ï¼š** ä¸å®¹å™¨åŒ–ç†å¿µä¸ç¬¦ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ

### ç”Ÿäº§ç¯å¢ƒï¼ˆå½“å‰æ–¹å¼ï¼‰

ä½¿ç”¨ COPY æ–¹å¼å›ºåŒ–ä»£ç åˆ°é•œåƒï¼š

**ä¼˜ç‚¹ï¼š**
- âœ… ä»£ç ä¸é•œåƒæ‰“åŒ…åœ¨ä¸€èµ·ï¼Œéƒ¨ç½²ä¸€è‡´æ€§é«˜
- âœ… ä¸ä¾èµ–å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿ
- âœ… å¯ä»¥æ–¹ä¾¿åœ°ç‰ˆæœ¬ç®¡ç†å’Œå›æ»š

**ç¼ºç‚¹ï¼š**
- âŒ æ›´æ–°ä»£ç éœ€è¦é‡æ–°æ„å»ºé•œåƒ

## ğŸ”„ æ›´æ–°æµç¨‹å›¾

```
æœ¬åœ°ä¿®æ”¹ä»£ç 
    â†“
æäº¤åˆ°Gitä»“åº“ï¼ˆå¯é€‰ï¼‰
    â†“
åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–æœ€æ–°ä»£ç  (git pull)
    â†“
åœæ­¢æ—§å®¹å™¨ (docker-compose down)
    â†“
é‡æ–°æ„å»ºé•œåƒ (docker-compose build --no-cache)
    â†“
å¯åŠ¨æ–°å®¹å™¨ (docker-compose up -d)
    â†“
éªŒè¯åŠŸèƒ½ (æŸ¥çœ‹æ—¥å¿—ã€æµ‹è¯•åŠŸèƒ½)
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ„å»ºå¤±è´¥

```bash
# æŸ¥çœ‹è¯¦ç»†æ„å»ºæ—¥å¿—
docker-compose build --no-cache --progress=plain

# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# æ¸…ç†Dockerç¼“å­˜
docker system prune -a
```

### é—®é¢˜2ï¼šå®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep 8001
```

### é—®é¢˜3ï¼šä»£ç ä»ç„¶æ˜¯æ—§çš„

```bash
# ç¡®è®¤æ˜¯å¦é‡æ–°æ„å»ºäº†é•œåƒ
docker images | grep outlook

# æŸ¥çœ‹é•œåƒåˆ›å»ºæ—¶é—´ï¼Œåº”è¯¥æ˜¯æœ€è¿‘çš„æ—¶é—´
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.CreatedAt}}"

# åˆ é™¤æ—§é•œåƒå¼ºåˆ¶é‡å»º
docker-compose down
docker rmi $(docker images | grep outlook | awk '{print $3}')
docker-compose build --no-cache
docker-compose up -d
```

### é—®é¢˜4ï¼šå‰ç«¯JSæ–‡ä»¶æ²¡æœ‰æ›´æ–°

æµè§ˆå™¨å¯èƒ½ç¼“å­˜äº†æ—§çš„JSæ–‡ä»¶ï¼š

1. æŒ‰ `Ctrl + F5` å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. ä½¿ç”¨æ— ç—•æ¨¡å¼æµ‹è¯•
4. æ£€æŸ¥å®¹å™¨å†…çš„æ–‡ä»¶ï¼š
   ```bash
   docker exec -it outlook-email-api ls -lh /app/static/js/accounts.js
   ```

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. Docker ç‰ˆæœ¬ï¼š`docker --version`
2. Docker Compose ç‰ˆæœ¬ï¼š`docker-compose --version`
3. å®¹å™¨çŠ¶æ€ï¼š`docker-compose ps`
4. å®¹å™¨æ—¥å¿—ï¼š`docker-compose logs --tail=100`
5. é•œåƒä¿¡æ¯ï¼š`docker images | grep outlook`
6. é”™è¯¯æˆªå›¾æˆ–è¯¦ç»†é”™è¯¯ä¿¡æ¯

