# 新功能使用说明

## 一、API Key 认证

### 1.1 功能说明

系统现在支持两种认证方式：
- **JWT Token 认证**（原有方式）：通过登录获取token，适合Web界面使用
- **API Key 认证**（新增）：使用固定的API Key，适合程序化调用

### 1.2 获取 API Key

API Key在系统首次启动时自动生成并保存在数据库中。您可以通过以下方式查看：

```python
import sqlite3
conn = sqlite3.connect("data.db")
cursor = conn.cursor()
cursor.execute("SELECT value FROM system_config WHERE key = 'api_key'")
api_key = cursor.fetchone()[0]
print(f"API Key: {api_key}")
conn.close()
```

或者查看服务器启动日志。

### 1.3 使用方式

#### 方式1: X-API-Key 请求头（推荐）

```bash
curl -H "X-API-Key: YOUR_API_KEY" http://localhost:8000/accounts
```

```python
import requests
headers = {"X-API-Key": "YOUR_API_KEY"}
response = requests.get("http://localhost:8000/accounts", headers=headers)
```

#### 方式2: Authorization 请求头

```bash
curl -H "Authorization: ApiKey YOUR_API_KEY" http://localhost:8000/accounts
```

### 1.4 安全建议

- API Key 具有完全访问权限，请妥善保管
- 建议在生产环境中定期更换 API Key
- 不要将 API Key 提交到版本控制系统

## 二、随机获取邮箱接口

### 2.1 接口说明

**端点**: `GET /accounts/random`

**描述**: 随机获取邮箱账户列表，支持标签筛选和分页

**认证**: 需要 API Key 或 JWT Token

### 2.2 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| include_tags | string | 否 | 必须包含的标签，多个用逗号分隔 |
| exclude_tags | string | 否 | 必须不包含的标签，多个用逗号分隔 |
| page | integer | 否 | 页码，从1开始，默认1 |
| page_size | integer | 否 | 每页数量，范围1-100，默认10 |

### 2.3 响应格式

```json
{
  "total_accounts": 10,
  "page": 1,
  "page_size": 10,
  "total_pages": 1,
  "accounts": [
    {
      "email_id": "user@outlook.com",
      "client_id": "client-id",
      "status": "active",
      "tags": ["标签1", "标签2"],
      "last_refresh_time": "2025-10-30T12:00:00",
      "next_refresh_time": "2025-11-02T12:00:00",
      "refresh_status": "success"
    }
  ]
}
```

### 2.4 使用示例

#### 示例1: 随机获取所有账户

```bash
curl -H "X-API-Key: YOUR_API_KEY" \
  "http://localhost:8000/accounts/random?page=1&page_size=5"
```

```python
import requests

headers = {"X-API-Key": "YOUR_API_KEY"}
response = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={"page": 1, "page_size": 5}
)
accounts = response.json()
print(f"获取到 {len(accounts['accounts'])} 个账户")
```

#### 示例2: 随机获取包含特定标签的账户

```bash
curl -H "X-API-Key: YOUR_API_KEY" \
  "http://localhost:8000/accounts/random?include_tags=工作,重要&page_size=10"
```

```python
response = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={
        "include_tags": "工作,重要",
        "page_size": 10
    }
)
```

#### 示例3: 随机获取不包含特定标签的账户

```bash
curl -H "X-API-Key: YOUR_API_KEY" \
  "http://localhost:8000/accounts/random?exclude_tags=禁用,过期"
```

```python
response = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={"exclude_tags": "禁用,过期"}
)
```

#### 示例4: 组合使用包含和排除标签

```bash
curl -H "X-API-Key: YOUR_API_KEY" \
  "http://localhost:8000/accounts/random?include_tags=工作&exclude_tags=禁用"
```

### 2.5 特殊情况

- 如果没有符合条件的账户，返回空列表（`accounts: []`），`total_accounts: 0`
- 每次请求都会随机排序，即使参数相同，返回的账户顺序也可能不同
- 分页是在随机排序后进行的

## 三、添加标签接口

### 3.1 接口说明

**端点**: `POST /accounts/{email_id}/tags/add`

**描述**: 为指定账户添加标签，如果标签已存在则不处理（幂等操作）

**认证**: 需要 API Key 或 JWT Token

### 3.2 路径参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| email_id | string | 邮箱地址 |

### 3.3 请求体

```json
{
  "tag": "标签名称"
}
```

### 3.4 响应格式

```json
{
  "email_id": "user@outlook.com",
  "message": "Tag '标签名称' added successfully."
}
```

或者（如果标签已存在）：

```json
{
  "email_id": "user@outlook.com",
  "message": "Tag '标签名称' already exists for account."
}
```

### 3.5 错误响应

**账户不存在** (404):
```json
{
  "detail": "Account user@outlook.com not found"
}
```

### 3.6 使用示例

#### 示例1: 添加单个标签

```bash
curl -X POST \
  -H "X-API-Key: YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"tag":"重要"}' \
  "http://localhost:8000/accounts/user@outlook.com/tags/add"
```

```python
import requests

headers = {
    "X-API-Key": "YOUR_API_KEY",
    "Content-Type": "application/json"
}

response = requests.post(
    "http://localhost:8000/accounts/user@outlook.com/tags/add",
    headers=headers,
    json={"tag": "重要"}
)

print(response.json()["message"])
```

#### 示例2: 批量添加多个标签

```python
import requests

headers = {
    "X-API-Key": "YOUR_API_KEY",
    "Content-Type": "application/json"
}

email = "user@outlook.com"
tags = ["工作", "重要", "高优先级"]

for tag in tags:
    response = requests.post(
        f"http://localhost:8000/accounts/{email}/tags/add",
        headers=headers,
        json={"tag": tag}
    )
    print(f"添加标签 '{tag}': {response.json()['message']}")
```

#### 示例3: 为多个账户添加相同标签

```python
import requests

headers = {
    "X-API-Key": "YOUR_API_KEY",
    "Content-Type": "application/json"
}

# 获取所有账户
accounts_response = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={"page_size": 100}
)
accounts = accounts_response.json()["accounts"]

# 为所有账户添加标签
for account in accounts:
    email = account["email_id"]
    response = requests.post(
        f"http://localhost:8000/accounts/{email}/tags/add",
        headers=headers,
        json={"tag": "批量处理"}
    )
    print(f"{email}: {response.json()['message']}")
```

### 3.7 与更新标签接口的区别

| 特性 | 添加标签 (POST /tags/add) | 更新标签 (PUT /tags) |
|------|--------------------------|----------------------|
| 操作方式 | 在现有标签列表后追加 | 完全替换标签列表 |
| 已存在处理 | 不处理（幂等） | 覆盖全部 |
| 使用场景 | 逐个添加标签 | 一次性设置全部标签 |

**建议**:
- 需要逐步添加标签时，使用 `POST /tags/add`
- 需要完全控制标签列表时，使用 `PUT /tags`

## 四、完整使用示例

### 4.1 场景：随机选择账户并添加标签

```python
import requests

API_KEY = "YOUR_API_KEY"
headers = {
    "X-API-Key": API_KEY,
    "Content-Type": "application/json"
}

# 1. 随机获取不包含"已处理"标签的账户
response = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={
        "exclude_tags": "已处理",
        "page_size": 5
    }
)

accounts = response.json()["accounts"]
print(f"找到 {len(accounts)} 个待处理账户")

# 2. 为每个账户添加"已处理"标签
for account in accounts:
    email = account["email_id"]
    
    # 添加标签
    response = requests.post(
        f"http://localhost:8000/accounts/{email}/tags/add",
        headers=headers,
        json={"tag": "已处理"}
    )
    
    print(f"✓ {email}: {response.json()['message']}")
```

### 4.2 场景：根据标签分类获取账户

```python
import requests

API_KEY = "YOUR_API_KEY"
headers = {"X-API-Key": API_KEY}

# 获取工作相关的账户
work_accounts = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={"include_tags": "工作"}
).json()["accounts"]

# 获取个人账户（排除工作标签）
personal_accounts = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={"exclude_tags": "工作"}
).json()["accounts"]

print(f"工作账户: {len(work_accounts)} 个")
print(f"个人账户: {len(personal_accounts)} 个")
```

## 五、注意事项

1. **API Key 安全**
   - 不要在公开的代码中硬编码 API Key
   - 建议使用环境变量存储
   - 定期更换 API Key

2. **标签筛选**
   - 标签匹配使用模糊匹配（SQL LIKE）
   - 多个标签使用逗号分隔
   - 标签名称区分大小写

3. **分页**
   - 随机排序在分页前执行
   - 每次请求的随机顺序可能不同
   - 建议根据实际需求调整 page_size

4. **幂等性**
   - 添加标签接口是幂等的，重复添加相同标签不会产生副作用
   - 适合在不确定标签是否已存在时使用

## 六、API 文档

完整的API文档可以通过以下方式访问：
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

在 API 文档中可以直接测试所有接口。

