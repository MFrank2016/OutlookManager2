# 数据库修复说明

## 问题描述

访问管理面板时出现错误：`内部服务器错误: database disk image is malformed`

这是SQLite数据库损坏的典型错误，可能由以下原因导致：
- 数据库文件在写入时被中断
- 磁盘空间不足
- 文件系统错误
- 并发写入冲突

## 已实施的修复

### 1. 改进数据库连接管理 (`database.py`)

- ✅ 添加数据库完整性检查（`PRAGMA quick_check`）
- ✅ 添加连接超时设置（10秒）
- ✅ 改进错误处理，特别针对数据库损坏错误
- ✅ 启用外键约束支持

### 2. 改进表数据访问函数

- ✅ 添加表名验证，防止SQL注入
- ✅ 添加针对数据库损坏错误的特殊处理
- ✅ 提供更清晰的错误信息

### 3. 改进管理面板API (`admin_api.py`)

- ✅ 添加单个表损坏时的容错处理
- ✅ 即使某个表损坏，也能继续显示其他表
- ✅ 损坏的表会显示记录数为 -1

## 使用方法

### 检查数据库状态

```bash
# 运行数据库修复脚本（会自动检查）
python3 scripts/repair_database.py
```

### 测试数据库访问

```bash
# 运行数据库访问测试
python3 scripts/test_database_access.py
```

### 如果数据库确实损坏

1. **自动备份**：修复脚本会自动创建备份
2. **尝试修复**：脚本会尝试使用 `.recover` 或 `.dump` 方法恢复数据
3. **重建数据库**（最后手段）：如果无法修复，可以重建数据库结构（会丢失数据）

## 预防措施

### 1. 定期备份

```bash
# 手动备份
cp data.db backups/data.db.$(date +%Y%m%d_%H%M%S)

# 或使用修复脚本（会自动备份）
python3 scripts/repair_database.py
```

### 2. 监控磁盘空间

确保有足够的磁盘空间，避免数据库写入失败。

### 3. 正确关闭应用

使用 `Ctrl+C` 或正常关闭命令停止应用，避免强制终止。

## 故障排查

### 问题1: 仍然出现 "database disk image is malformed" 错误

**解决步骤**：
1. 停止应用
2. 运行修复脚本：`python3 scripts/repair_database.py`
3. 检查备份目录中的恢复文件
4. 如果修复成功，重启应用

### 问题2: 某个表无法访问

**症状**：管理面板中某个表显示记录数为 -1

**解决步骤**：
1. 检查该表是否确实损坏
2. 如果只是该表损坏，可以尝试：
   - 导出其他表的数据
   - 重建数据库结构
   - 重新导入数据

### 问题3: 数据库文件不存在

**解决步骤**：
1. 检查数据库文件路径是否正确
2. 运行数据库初始化：`python3 -c "import database; database.init_database()"`

## 相关文件

- `scripts/repair_database.py` - 数据库修复脚本
- `scripts/test_database_access.py` - 数据库访问测试脚本
- `database.py` - 数据库管理模块（已改进）
- `admin_api.py` - 管理面板API（已改进）

## 技术细节

### 数据库完整性检查

修复后的代码会在每次数据库连接时执行快速完整性检查：

```python
# 快速检查（推荐）
PRAGMA quick_check

# 完整检查（较慢，仅在必要时使用）
PRAGMA integrity_check
```

### 错误处理流程

1. 连接时检查数据库完整性
2. 如果检查失败，记录错误并抛出异常
3. 在API层面捕获错误，提供友好的错误信息
4. 对于单个表的错误，继续处理其他表

## 注意事项

⚠️ **重要**：
- 数据库修复可能会丢失部分数据
- 建议在修复前先备份数据库
- 如果数据非常重要，考虑使用专业的数据库恢复工具

## 更新日志

- 2025-12-01: 初始版本，添加数据库修复功能和改进的错误处理

