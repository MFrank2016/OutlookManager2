# 系统更新日志 - 2025-11-02

## 🎉 新功能

### 1. 批量删除账户功能
- ✅ 支持全选/单选账户
- ✅ 实时显示已选数量
- ✅ 批量删除按钮（选中后自动显示）
- ✅ 二次确认防止误删
- ✅ 详细的成功/失败报告
- ✅ 自动刷新列表

**API端点**: `POST /accounts/batch-delete`

**前端位置**: 账户管理页面

### 2. 分页大小设置功能
- ✅ 支持 10/20/50/100 条/页
- ✅ 下拉选择器，操作便捷
- ✅ 切换后自动加载第一页
- ✅ 自动清空已选账户
- ✅ 响应式设计

**前端位置**: 账户管理页面统计信息栏右侧

## 🐛 Bug 修复

### 1. 修复启动错误
**问题**: `module 'database' has no attribute 'get_all_accounts'`

**原因**: `main.py` 中调用了不存在的函数 `db.get_all_accounts()`

**解决方案**: 
- 将 `db.get_all_accounts()` 改为 `db.get_all_accounts_db(page=1, page_size=1000)`
- 更新变量接收返回值

**文件**: `main.py` 第 246 行

### 2. 添加 favicon 支持
**问题**: 浏览器请求 `/favicon.ico` 返回 404 错误

**解决方案**:
- 在 `main.py` 中添加 `/favicon.ico` 路由
- 在所有 HTML 文件中添加 favicon 链接
- 如果 favicon 文件不存在，返回 204 No Content

**修改文件**:
- `main.py` - 添加 favicon 路由
- `static/index.html` - 添加 favicon 链接
- `static/templates/base.html` - 添加 favicon 链接
- `static/login.html` - 添加 favicon 链接

### 3. 修复 Docker 配置
**问题**: 
1. Dockerfile 中缺少 `permissions.py` 文件
2. 健康检查使用了不必要的 requests 库

**解决方案**:
- 在 Dockerfile 中添加 `COPY permissions.py .`
- 将健康检查改为使用 Python 内置的 `urllib.request`

**修改文件**:
- `docker/Dockerfile`
- `docker-compose.yml`

## 📝 代码改进

### 后端
1. **models.py**
   - 新增 `BatchDeleteRequest` 模型
   - 新增 `BatchDeleteResult` 模型

2. **routes/account_routes.py**
   - 新增 `batch_delete_accounts` 端点
   - 完整的错误处理和日志记录

3. **main.py**
   - 修复 `warmup_cache()` 函数
   - 添加 `favicon()` 路由

### 前端
1. **static/templates/pages/accounts.html**
   - 重构统计信息栏
   - 添加全选复选框
   - 添加分页大小选择器
   - 添加批量删除按钮

2. **static/js/accounts.js**
   - 新增批量选择功能
   - 新增批量删除功能
   - 新增分页大小切换功能
   - 更新账户列表渲染逻辑

3. **static/css/accounts.css**
   - 新增统计信息栏样式
   - 新增复选框样式
   - 新增分页选择器样式
   - 响应式设计优化

## 🔒 安全性

1. **权限控制**: 批量删除需要管理员权限
2. **二次确认**: 删除前需要用户确认
3. **详细日志**: 记录所有批量删除操作
4. **错误处理**: 单个账户删除失败不影响其他账户

## 📱 用户体验

1. **视觉反馈**: 选中账户后按钮自动显示，实时更新计数
2. **操作流程**: 选择 → 确认 → 执行 → 反馈
3. **错误提示**: 清晰的成功/失败消息
4. **移动端**: 完全响应式设计

## 🧪 测试状态

- ✅ Python 代码编译通过
- ✅ 无 linter 错误
- ✅ 系统启动成功
- ✅ 前端模块加载成功

## 📚 文档

新增文档：
- `docs/FEATURE_BATCH_DELETE_AND_PAGE_SIZE.md` - 批量删除和分页功能详细文档
- `docs/UPDATES_2025-11-02.md` - 本更新日志

## 🚀 部署说明

### 重新构建 Docker 镜像
```bash
docker-compose build
```

### 重启服务
```bash
docker-compose down
docker-compose up -d
```

### 本地开发
```bash
# 激活虚拟环境
source venv/bin/activate

# 启动服务
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

## ⚠️ 注意事项

1. **数据库**: 无需迁移，使用现有数据库结构
2. **兼容性**: 向后兼容，不影响现有功能
3. **权限**: 批量删除需要管理员权限
4. **浏览器**: 建议使用最新版本的 Chrome、Firefox、Safari 或 Edge

## 📊 统计

- 修改文件数: 10
- 新增代码行数: ~400
- 新增 API 端点: 1
- 修复 Bug: 3
- 新增功能: 2

## 👥 贡献者

Outlook Manager Team

## 📅 更新日期

2025-11-02

