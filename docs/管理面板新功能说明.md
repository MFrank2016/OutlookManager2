# 管理面板新功能使用说明

## 概述

管理面板现已集成两个新的API接口，提供可视化的试用功能：
1. **随机获取邮箱接口** - 随机获取符合条件的邮箱账户
2. **添加标签接口** - 为指定账户添加单个标签

## 访问管理面板

1. 启动服务器：`python main.py`
2. 打开浏览器访问：http://localhost:8000
3. 使用管理员账号登录（默认：admin/admin123）
4. 点击"📚 API文档"标签查看所有接口

## 新增接口位置

新接口位于"账户管理"分类下，在"更新账户标签"接口之后：

```
📚 API文档
  └─ 账户管理
      ├─ GET /accounts (获取邮箱列表)
      ├─ POST /accounts/{email_id}/refresh-token (刷新Token)
      ├─ POST /accounts/batch-refresh-tokens (批量刷新Token)
      ├─ POST /accounts (添加账户)
      ├─ DELETE /accounts/{email_id} (删除账户)
      ├─ PUT /accounts/{email_id}/tags (更新标签)
      ├─ POST /accounts/{email_id}/tags/add (添加标签) ⭐新增
      └─ GET /accounts/random (随机获取邮箱) ⭐新增
```

## 1. 随机获取邮箱接口

### 接口信息
- **方法**: GET
- **路径**: `/accounts/random`
- **图标**: 🎲

### 功能说明
随机获取邮箱账户列表，支持标签筛选和分页。每次请求返回的顺序都是随机的。

### 使用步骤

1. **找到接口**
   - 在管理面板中滚动到"账户管理"分类
   - 找到"GET /accounts/random"接口

2. **点击试用按钮**
   - 点击接口右侧的"🚀 试用接口"按钮
   - 弹出API测试对话框

3. **配置参数**
   
   对话框中会显示以下参数：
   
   | 参数 | 类型 | 默认值 | 说明 |
   |------|------|--------|------|
   | include_tags | text | (空) | 必须包含的标签，多个用逗号分隔 |
   | exclude_tags | text | (空) | 必须不包含的标签，多个用逗号分隔 |
   | page | number | 1 | 页码 |
   | page_size | number | 5 | 每页数量 |

4. **设置筛选条件**

   **场景1**: 随机获取所有账户
   ```
   include_tags: (留空)
   exclude_tags: (留空)
   page: 1
   page_size: 10
   ```

   **场景2**: 获取包含"工作"标签的账户
   ```
   include_tags: 工作
   exclude_tags: (留空)
   page: 1
   page_size: 5
   ```

   **场景3**: 获取不包含"禁用"标签的账户
   ```
   include_tags: (留空)
   exclude_tags: 禁用
   page: 1
   page_size: 10
   ```

   **场景4**: 组合筛选
   ```
   include_tags: 工作,重要
   exclude_tags: 禁用,过期
   page: 1
   page_size: 5
   ```

5. **执行测试**
   - 点击"🚀 执行测试"按钮
   - 查看右侧的响应结果

6. **查看结果**
   
   成功响应示例：
   ```json
   {
     "total_accounts": 20,
     "page": 1,
     "page_size": 5,
     "total_pages": 4,
     "accounts": [
       {
         "email_id": "user@outlook.com",
         "client_id": "client-id",
         "status": "active",
         "tags": ["工作", "重要"],
         "last_refresh_time": "2025-10-30T12:00:00",
         "next_refresh_time": "2025-11-02T12:00:00",
         "refresh_status": "success"
       }
     ]
   }
   ```

### 使用技巧

1. **随机性**
   - 每次请求都会随机排序
   - 相同参数多次请求，顺序可能不同
   - 适合需要避免重复使用同一批邮箱的场景

2. **标签筛选**
   - 支持多个标签组合（逗号分隔）
   - 标签匹配使用模糊匹配
   - include_tags 和 exclude_tags 可以同时使用

3. **分页**
   - 随机排序在分页前执行
   - 建议根据实际需求调整page_size
   - 无结果时返回空列表，不报错

## 2. 添加标签接口

### 接口信息
- **方法**: POST
- **路径**: `/accounts/{email_id}/tags/add`
- **图标**: 🏷️

### 功能说明
为指定账户添加单个标签。如果标签已存在则不处理（幂等操作）。

### 使用步骤

1. **找到接口**
   - 在管理面板中找到"POST /accounts/{email_id}/tags/add"接口

2. **点击试用按钮**
   - 点击"🚀 试用接口"按钮

3. **配置参数**

   **路径参数**:
   | 参数 | 类型 | 默认值 | 说明 |
   |------|------|--------|------|
   | email_id | text | example@outlook.com | 邮箱地址 |

   **请求体**:
   | 参数 | 类型 | 默认值 | 说明 |
   |------|------|--------|------|
   | tag | text | VIP | 要添加的标签名称 |

4. **输入参数**

   **场景1**: 为账户添加VIP标签
   ```
   路径参数:
     email_id: user@outlook.com
   
   请求体:
     {
       "tag": "VIP"
     }
   ```

   **场景2**: 标记账户为测试账户
   ```
   路径参数:
     email_id: test@outlook.com
   
   请求体:
     {
       "tag": "测试"
     }
   ```

5. **执行测试**
   - 确认邮箱地址正确
   - 点击"🚀 执行测试"按钮

6. **查看结果**

   **成功响应（新标签）**:
   ```json
   {
     "email_id": "user@outlook.com",
     "message": "Tag 'VIP' added successfully."
   }
   ```

   **成功响应（已存在）**:
   ```json
   {
     "email_id": "user@outlook.com",
     "message": "Tag 'VIP' already exists for account."
   }
   ```

   **失败响应（账户不存在）**:
   ```json
   {
     "detail": "Account user@outlook.com not found"
   }
   ```

### 特性说明

1. **幂等操作**
   - 重复添加相同标签不会报错
   - 适合在不确定标签是否已存在时使用
   - 返回消息会提示标签是新增还是已存在

2. **追加模式**
   - 新标签添加到现有标签列表末尾
   - 不会覆盖或删除现有标签
   - 如需替换全部标签，使用PUT /accounts/{email_id}/tags

3. **错误处理**
   - 账户不存在时返回404错误
   - 响应消息清晰明了
   - 所有错误都有详细的错误信息

## 与其他接口的配合使用

### 工作流1: 随机选择并标记

1. 使用"随机获取邮箱"接口获取一个未使用的账户
   ```
   GET /accounts/random?exclude_tags=使用中&page_size=1
   ```

2. 记录返回的邮箱地址

3. 使用"添加标签"接口标记为使用中
   ```
   POST /accounts/{email}/tags/add
   Body: {"tag": "使用中"}
   ```

### 工作流2: 批量标记特定类别

1. 使用"获取邮箱列表"接口获取特定账户
   ```
   GET /accounts?tag_search=工作
   ```

2. 对每个账户使用"添加标签"接口
   ```
   POST /accounts/{email}/tags/add
   Body: {"tag": "重要"}
   ```

### 工作流3: 按标签随机测试

1. 使用"随机获取邮箱"获取测试账户
   ```
   GET /accounts/random?include_tags=测试&page_size=3
   ```

2. 对每个测试账户进行操作

3. 完成后添加"已测试"标签
   ```
   POST /accounts/{email}/tags/add
   Body: {"tag": "已测试"}
   ```

## 快捷操作

### 快速查找邮箱地址

如果不记得邮箱地址，可以：
1. 先访问"账户列表"标签页查看所有账户
2. 复制需要的邮箱地址
3. 返回API文档标签页进行测试

### 批量操作建议

对于批量操作，建议：
1. 在管理面板测试单个请求
2. 确认参数和响应格式正确
3. 使用Python脚本进行批量操作（参考test_new_features.py）

## 常见问题

### Q1: 为什么随机接口每次返回顺序不同？

**A**: 这是设计行为。每次请求都会重新随机排序，确保真正的随机性。如果需要固定顺序，请使用GET /accounts接口。

### Q2: 添加标签接口和更新标签接口有什么区别？

**A**: 
- **添加标签** (POST /tags/add): 在现有标签后追加一个标签，幂等操作
- **更新标签** (PUT /tags): 完全替换标签列表

选择建议：
- 逐步添加标签 → 使用添加标签接口
- 一次性设置全部标签 → 使用更新标签接口

### Q3: 如何验证标签是否添加成功？

**A**: 有三种方式：
1. 查看接口响应消息
2. 在"账户列表"标签页查看账户的标签列
3. 使用GET /accounts接口查询该账户

### Q4: 试用按钮点击后没反应？

**A**: 可能的原因：
1. 未登录或登录已过期 → 重新登录
2. 浏览器JavaScript被禁用 → 启用JavaScript
3. 网络连接问题 → 检查服务器是否运行

## 技术说明

### 认证方式

管理面板中的API测试功能会自动使用当前登录的JWT Token进行认证，无需手动配置API Key。

如果需要使用API Key进行程序化调用，请参考：
- [新功能使用说明.md](./新功能使用说明.md)
- [快速开始_新功能.md](./快速开始_新功能.md)

### 浏览器兼容性

管理面板支持以下浏览器：
- Chrome/Edge (推荐)
- Firefox
- Safari

## 反馈与支持

如遇到问题或有改进建议，请：
1. 查看服务器日志：`logs/outlook_manager.log`
2. 访问API文档：http://localhost:8000/docs
3. 查看更新日志：`CHANGELOG.md`

---

**最后更新**: 2025-10-31  
**版本**: v2.1.0

