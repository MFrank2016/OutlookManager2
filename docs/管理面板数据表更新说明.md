# 管理面板数据表更新说明

## 更新时间
2025-11-01

## 更新内容

### 1. 数据表字段完整性更新

已更新管理面板中所有数据表的字段信息，确保与数据库实际结构一致。

### 2. 各表详细字段信息

#### accounts 表（邮箱账户信息表）
**新增字段**: `api_method` - API访问方法（'graph_api' 或 'imap'）

**完整字段列表** (14个字段):
1. `id` (INTEGER) - 主键
2. `email` (TEXT) - 邮箱地址
3. `refresh_token` (TEXT) - OAuth2刷新令牌
4. `client_id` (TEXT) - 客户端ID
5. `tags` (TEXT) - 标签（JSON格式）
6. `last_refresh_time` (TEXT) - 最后刷新时间
7. `next_refresh_time` (TEXT) - 下次刷新时间
8. `refresh_status` (TEXT) - 刷新状态
9. `refresh_error` (TEXT) - 刷新错误信息
10. `created_at` (TEXT) - 创建时间
11. `updated_at` (TEXT) - 更新时间
12. `access_token` (TEXT) - 访问令牌（缓存）
13. `token_expires_at` (TEXT) - 令牌过期时间
14. **`api_method` (TEXT)** - **API方法** ✨ 新增

#### admins 表（管理员账户表）
**字段列表** (7个字段):
1. `id` (INTEGER) - 主键
2. `username` (TEXT) - 用户名
3. `password_hash` (TEXT) - 密码哈希
4. `email` (TEXT) - 邮箱
5. `is_active` (INTEGER) - 是否激活
6. `created_at` (TEXT) - 创建时间
7. `last_login` (TEXT) - 最后登录时间

#### system_config 表（系统配置表）
**字段列表** (5个字段):
1. `id` (INTEGER) - 主键
2. `key` (TEXT) - 配置键
3. `value` (TEXT) - 配置值
4. `description` (TEXT) - 描述
5. `updated_at` (TEXT) - 更新时间

#### emails_cache 表（邮件列表缓存表）
**包含LRU缓存管理字段**

**完整字段列表** (15个字段):
1. `id` (INTEGER) - 主键
2. `email_account` (TEXT) - 邮箱账户
3. `message_id` (TEXT) - 邮件ID
4. `folder` (TEXT) - 文件夹
5. `subject` (TEXT) - 主题
6. `from_email` (TEXT) - 发件人
7. `date` (TEXT) - 日期
8. `is_read` (INTEGER) - 是否已读
9. `has_attachments` (INTEGER) - 是否有附件
10. `sender_initial` (TEXT) - 发件人首字母
11. `created_at` (TEXT) - 创建时间
12. `verification_code` (TEXT) - 验证码
13. `access_count` (INTEGER) - 访问次数（LRU）
14. `last_accessed_at` (TEXT) - 最后访问时间（LRU）
15. `cache_size` (INTEGER) - 缓存大小（LRU）

#### email_details_cache 表（邮件详情缓存表）
**包含LRU缓存管理字段**

**完整字段列表** (14个字段):
1. `id` (INTEGER) - 主键
2. `email_account` (TEXT) - 邮箱账户
3. `message_id` (TEXT) - 邮件ID
4. `subject` (TEXT) - 主题
5. `from_email` (TEXT) - 发件人
6. `to_email` (TEXT) - 收件人
7. `date` (TEXT) - 日期
8. `body_plain` (TEXT) - 纯文本正文
9. `body_html` (TEXT) - HTML正文
10. `created_at` (TEXT) - 创建时间
11. `verification_code` (TEXT) - 验证码
12. `access_count` (INTEGER) - 访问次数（LRU）
13. `last_accessed_at` (TEXT) - 最后访问时间（LRU）
14. `body_size` (INTEGER) - 正文大小（LRU）

### 3. 管理面板界面更新

#### 更新内容：
1. **字段数量显示**: 在表描述下方显示每个表的字段数量
2. **字段详情提示**: 鼠标悬停在表行上时，显示完整的字段列表
3. **表描述优化**: 更新了表描述，标注了重要特性
   - accounts: "邮箱账户信息表 (含API方法字段)"
   - emails_cache: "邮件列表缓存表 (含LRU字段)"
   - email_details_cache: "邮件详情缓存表 (含LRU字段)"

#### 显示效果：
```
图标 | 表名               | 描述                                    | 记录数 | 操作
👥   | accounts          | 邮箱账户信息表 (含API方法字段)          | 10     | 查看数据
                          | 字段数: 14
🔐   | admins            | 管理员账户表                            | 2      | 查看数据
                          | 字段数: 7
⚙️   | system_config     | 系统配置表                              | 5      | 查看数据
                          | 字段数: 5
📧   | emails_cache      | 邮件列表缓存表 (含LRU字段)              | 150    | 查看数据
                          | 字段数: 15
📨   | email_details_cache| 邮件详情缓存表 (含LRU字段)             | 50     | 查看数据
                          | 字段数: 14
```

### 4. 关键字段说明

#### api_method 字段（accounts表）
- **类型**: TEXT
- **默认值**: 'imap'
- **可选值**: 
  - `'graph_api'` - 使用 Microsoft Graph API
  - `'imap'` - 使用传统 IMAP 协议
- **用途**: 标识账户使用的邮件访问方法
- **自动检测**: 可通过 `/accounts/{email_id}/detect-api-method` 接口自动检测并更新

#### LRU 缓存字段
用于实现最近最少使用（LRU）缓存淘汰策略：

**emails_cache 表**:
- `access_count` - 记录访问次数
- `last_accessed_at` - 最后访问时间
- `cache_size` - 缓存项大小

**email_details_cache 表**:
- `access_count` - 记录访问次数
- `last_accessed_at` - 最后访问时间
- `body_size` - 邮件正文大小

### 5. 数据表统计

| 表名 | 字段数 | 主要用途 | 特殊字段 |
|------|--------|----------|----------|
| accounts | 14 | 存储邮箱账户信息 | api_method (新增) |
| admins | 7 | 存储管理员账户 | - |
| system_config | 5 | 存储系统配置 | - |
| emails_cache | 15 | 缓存邮件列表 | LRU字段 |
| email_details_cache | 14 | 缓存邮件详情 | LRU字段 |

**总计**: 5个数据表，55个字段

### 6. 使用建议

#### 查看 api_method 字段
1. 进入管理面板 → 数据表管理
2. 点击 "accounts" 表
3. 查看 "Api Method" 列，显示每个账户的API方法

#### 检测和更新 API 方法
```bash
# 通过API检测单个账户
POST /accounts/{email_id}/detect-api-method

# 或在管理面板中直接编辑 api_method 字段
```

#### 监控缓存使用情况
1. 进入管理面板 → 缓存统计
2. 查看缓存命中率和使用情况
3. 必要时执行 LRU 清理

### 7. 维护建议

#### 定期检查
- **每周**: 检查 accounts 表的 api_method 字段分布
- **每月**: 清理过期的缓存数据
- **按需**: 执行 LRU 清理释放空间

#### 性能优化
- Graph API 账户通常比 IMAP 更快
- 建议将支持的账户迁移到 Graph API
- 监控 LRU 缓存命中率，调整缓存策略

### 8. 相关文档

- [Graph API 集成文档](../GRAPH_API_INTEGRATION.md)
- [实施总结](../IMPLEMENTATION_SUMMARY.md)
- [缓存优化文档](./缓存优化完成总结.md)

## 更新日志

### 2025-11-01
- ✅ 添加 accounts 表 api_method 字段
- ✅ 更新所有表的完整字段信息
- ✅ 优化管理面板显示，增加字段数量和提示
- ✅ 更新表描述，标注重要特性
- ✅ 创建本文档

## 验证清单

- [x] accounts 表包含 api_method 字段
- [x] 所有表字段信息完整
- [x] 管理面板显示字段数量
- [x] 鼠标悬停显示字段列表
- [x] 表描述准确反映表特性
- [x] LRU 字段正确标注
- [x] 文档完整记录所有变更

