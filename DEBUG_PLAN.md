# 倒计时重复请求问题排查计划

## 问题描述
倒计时结束后仍然有两次请求被触发。

## 排查步骤

### 1. 检查日志输出模式
当倒计时结束时，在浏览器控制台查找以下日志：

#### 关键日志点：
1. **`[倒计时调试] 倒计时结束，准备刷新`**
   - 检查这个日志是否出现两次
   - 记录两次出现的时间戳差异
   - 检查两次的账户信息是否相同

2. **`[倒计时调试] 触发 refetch`**
   - 检查这个日志是否出现两次
   - 如果出现两次，说明倒计时逻辑被触发了两次
   - 如果只出现一次，但请求有两次，说明问题在 React Query 层面

3. **`[useEmails] queryFn 被调用`**
   - 检查这个日志出现的次数
   - 记录每次调用的时间戳
   - 检查每次调用的 queryKey 是否相同
   - **重要**：检查 stackTrace，看调用来源

4. **`[useEmails] 发送 API 请求`**
   - 检查这个日志出现的次数
   - 记录每次请求的账户和参数

### 2. 可能的原因分析

#### 原因 A: 多个 useEffect 实例同时运行
**症状**：
- `[倒计时调试] useEffect 触发` 日志出现多次
- 每次的账户信息相同，但时间戳不同

**检查方法**：
- 查看 `[倒计时调试] 开始倒计时 interval` 日志出现的次数
- 如果出现多次，说明有多个 interval 在运行

**解决方案**：
- 确保 useEffect 的清理函数正确执行
- 检查依赖项是否正确

#### 原因 B: React Query 的 queryKey 不稳定
**症状**：
- `[useEmails] queryFn 被调用` 出现两次
- 两次调用的 queryKey 相同，但时间戳非常接近

**检查方法**：
- 查看 `[useEmails] queryFn 被调用` 日志中的 queryKey
- 检查 queryKey 数组中的每个值是否稳定

**解决方案**：
- 确保 queryKey 中的所有值都是原始类型（string, number, boolean）
- 避免在 queryKey 中使用对象或数组

#### 原因 C: refetch 函数被多次调用
**症状**：
- `[倒计时调试] 触发 refetch` 只出现一次
- 但 `[useEmails] queryFn 被调用` 出现两次

**检查方法**：
- 查看 `[倒计时调试] refetch 调用完成，等待响应` 日志
- 检查 refetchPromise 是否是同一个对象

**解决方案**：
- 检查 React Query 的配置
- 确保 refetchOnMount、refetchOnWindowFocus 等选项已禁用

#### 原因 D: 组件重新渲染导致的问题
**症状**：
- `[倒计时调试] useEffect 触发` 频繁出现
- 每次触发时账户信息相同

**检查方法**：
- 查看 useEffect 的依赖项变化
- 检查是否有不必要的状态更新

**解决方案**：
- 优化依赖项
- 使用 useMemo 或 useCallback 稳定引用

### 3. 日志分析检查清单

当倒计时结束时，按以下顺序检查日志：

1. ✅ **倒计时结束日志**
   ```
   [倒计时调试] 倒计时结束，准备刷新
   ```
   - 出现次数：应该是 1 次
   - 如果不是 1 次，记录出现次数和时间戳

2. ✅ **触发 refetch 日志**
   ```
   [倒计时调试] 触发 refetch
   ```
   - 出现次数：应该是 1 次
   - 如果不是 1 次，说明倒计时逻辑有问题

3. ✅ **queryFn 调用日志**
   ```
   [useEmails] queryFn 被调用
   ```
   - 出现次数：应该是 1 次
   - 如果出现 2 次，检查：
     - 两次调用的时间戳差异（应该 > 100ms）
     - 两次调用的 queryKey 是否完全相同
     - 两次调用的 stackTrace 来源

4. ✅ **API 请求日志**
   ```
   [useEmails] 发送 API 请求
   ```
   - 出现次数：应该是 1 次
   - 如果出现 2 次，检查：
     - 两次请求的账户是否相同
     - 两次请求的参数是否相同
     - 两次请求的时间戳差异

### 4. 关键数据收集

在控制台执行以下操作后，收集以下信息：

1. **倒计时结束时的完整日志序列**
   - 复制从 "倒计时结束" 到 "API 请求完成" 的所有日志
   - 记录每个日志的时间戳

2. **useEffect 触发频率**
   - 在倒计时期间，记录 `[倒计时调试] useEffect 触发` 出现的次数
   - 记录每次触发的原因（依赖项变化）

3. **interval 创建和清理**
   - 记录 `[倒计时调试] 开始倒计时 interval` 出现的次数
   - 记录 `[倒计时调试] 清理 interval` 出现的次数
   - 两者应该相等

### 5. 预期行为

正常情况下，倒计时结束时应该看到：

```
[倒计时调试] 倒计时结束，准备刷新
[倒计时调试] 触发 refetch
[倒计时调试] refetch 调用完成，等待响应
[useEmails] queryFn 被调用
[useEmails] 发送 API 请求
[useEmails] API 请求完成
[倒计时调试] refetch 完成
[倒计时调试] 刷新标志已重置
```

每个日志应该只出现 **1 次**。

### 6. 如果发现重复

如果发现某个日志出现 2 次：

1. **记录两次出现的时间戳差异**
   - 如果 < 10ms：可能是 React 的批处理导致
   - 如果 10-100ms：可能是异步竞态条件
   - 如果 > 100ms：可能是多个实例或逻辑错误

2. **检查两次调用的上下文**
   - 账户信息是否相同
   - queryKey 是否相同
   - stackTrace 来源是否相同

3. **根据发现的问题类型，应用相应的解决方案**

## 下一步

1. 打开浏览器控制台
2. 等待倒计时结束
3. 收集上述所有日志
4. 根据日志分析问题原因
5. 应用相应的修复方案

