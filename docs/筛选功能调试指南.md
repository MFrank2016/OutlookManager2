# 筛选功能调试指南

## 更新时间
2024年10月30日

## 概述

为了排查"指定刷新条件"筛选功能的问题，我们在前端和后端都添加了详细的日志。本文档说明如何查看和分析这些日志。

---

## 日志位置

### 前端日志（浏览器控制台）

**位置**: 浏览器开发者工具 → Console（控制台）

**打开方式**:
- Chrome/Edge: 按 `F12` 或 `Ctrl+Shift+I`
- Firefox: 按 `F12` 或 `Ctrl+Shift+K`
- Safari: 按 `Cmd+Option+I` (需先启用开发者菜单)

### 后端日志（服务器文件）

**位置**: `logs/outlook_manager.log`

**查看方式**:
```bash
# 实时查看日志（Linux/Mac）
tail -f logs/outlook_manager.log

# Windows PowerShell
Get-Content logs/outlook_manager.log -Wait

# 查看最后50行
tail -n 50 logs/outlook_manager.log
```

---

## 前端日志说明

### 1. 状态变化日志

**触发时机**: 用户选择刷新状态筛选器

**日志示例**:
```javascript
[筛选] 状态变化: custom
[筛选] 设置默认日期范围:
  起始时间: 2024-09-30T14:30:00.000Z
  截止时间: 2024-10-30T14:30:00.000Z
```

**关键检查点**:
- ✅ `状态变化` 应该显示选择的值（`custom`、`all`、`failed`等）
- ✅ 如果选择 `custom`，应该看到默认日期范围的ISO格式时间
- ✅ 起始时间应该是30天前，截止时间应该是当前时间

### 2. 搜索日志

**触发时机**: 用户点击"搜索"按钮

**日志示例**:
```javascript
[搜索] 开始搜索...
[搜索] 当前筛选条件:
  邮箱搜索: 
  标签搜索: 
  状态筛选: custom
[搜索] 自定义模式 - 输入框值:
  起始时间输入: 2024-10-01T00:00
  截止时间输入: 2024-10-30T23:59
[搜索] 转换为ISO格式:
  起始时间: 2024-10-01T00:00:00.000Z
  截止时间: 2024-10-30T23:59:00.000Z
```

**关键检查点**:
- ✅ `状态筛选` 应该是 `custom`
- ✅ 输入框值应该有内容（格式：`YYYY-MM-DDTHH:mm`）
- ✅ ISO格式时间应该正确转换（格式：`YYYY-MM-DDTHH:mm:ss.sssZ`）

### 3. 应用筛选日志

**触发时机**: 用户点击"应用筛选"按钮

**日志示例**:
```javascript
[应用筛选] 开始应用自定义日期筛选...
[应用筛选] 输入框值:
  起始时间: 2024-10-01T00:00
  截止时间: 2024-10-30T23:59
[应用筛选] 转换为ISO格式:
  起始时间: 2024-10-01T00:00:00.000Z
  截止时间: 2024-10-30T23:59:00.000Z
```

### 4. 请求参数日志

**触发时机**: 发送API请求前

**日志示例**:
```javascript
[筛选] 添加日期范围参数:
  refresh_start_date: 2024-10-01T00:00:00.000Z
  refresh_end_date: 2024-10-30T23:59:00.000Z
[筛选] 完整请求参数: page=1&page_size=10&refresh_start_date=2024-10-01T00:00:00.000Z&refresh_end_date=2024-10-30T23:59:00.000Z
```

**关键检查点**:
- ✅ 应该看到 `refresh_start_date` 和 `refresh_end_date` 参数
- ✅ 参数值应该是ISO格式的完整时间戳
- ✅ 完整请求参数中应该包含这两个参数

### 5. 警告日志

**触发时机**: 选择了 `custom` 但日期参数为空

**日志示例**:
```javascript
[筛选] 警告: 自定义模式但日期参数为空!
  currentRefreshStartDate: 
  currentRefreshEndDate: 
```

**问题分析**:
- ❌ 如果看到这个警告，说明全局变量没有正确设置
- ❌ 这会导致日期范围参数不会传递给后端

---

## 后端日志说明

### 1. API请求日志

**位置**: `logs/outlook_manager.log`

**日志示例**:
```
2024-10-30 14:30:00 - INFO - [API] GET /accounts 收到请求:
2024-10-30 14:30:00 - INFO -   page=1, page_size=10
2024-10-30 14:30:00 - INFO -   email_search=None, tag_search=None
2024-10-30 14:30:00 - INFO -   refresh_status=None, time_filter=None
2024-10-30 14:30:00 - INFO -   after_date=None
2024-10-30 14:30:00 - INFO -   refresh_start_date=2024-10-01T00:00:00.000Z
2024-10-30 14:30:00 - INFO -   refresh_end_date=2024-10-30T23:59:00.000Z
```

**关键检查点**:
- ✅ `refresh_start_date` 和 `refresh_end_date` 应该有值（不是 `None`）
- ✅ 时间格式应该是ISO 8601格式
- ❌ 如果这两个参数是 `None`，说明前端没有正确传递参数

### 2. 数据库筛选日志

**日志示例**:
```
2024-10-30 14:30:00 - INFO - [筛选] 添加日期范围筛选: 2024-10-01T00:00:00.000Z 至 2024-10-30T23:59:00.000Z
2024-10-30 14:30:00 - INFO - [筛选] SQL WHERE子句: (last_refresh_time >= ? AND last_refresh_time <= ?)
2024-10-30 14:30:00 - INFO - [筛选] SQL参数: ['2024-10-01T00:00:00.000Z', '2024-10-30T23:59:00.000Z', 10, 0]
2024-10-30 14:30:00 - INFO - [筛选] 符合条件的总数: 5
```

**关键检查点**:
- ✅ 应该看到"添加日期范围筛选"日志
- ✅ SQL WHERE子句中应该包含 `last_refresh_time >= ? AND last_refresh_time <= ?`
- ✅ SQL参数列表中应该包含日期范围值
- ✅ 符合条件的总数应该反映实际筛选结果

### 3. 查询结果日志

**日志示例**:
```
2024-10-30 14:30:00 - INFO - [API] 查询结果: 总数=5, 返回=5条
```

**关键检查点**:
- ✅ 总数应该与实际符合条件的账户数匹配
- ✅ 返回数量应该 ≤ page_size

---

## 常见问题诊断

### 问题1: 选择"指定刷新条件"后显示所有账户

**诊断步骤**:

1. **检查浏览器控制台**
   ```javascript
   // 应该看到：
   [筛选] 状态变化: custom
   [筛选] 设置默认日期范围:
     起始时间: 2024-09-30T...
     截止时间: 2024-10-30T...
   ```

2. **检查请求参数**
   ```javascript
   // 应该看到：
   [筛选] 添加日期范围参数:
     refresh_start_date: 2024-09-30T...
     refresh_end_date: 2024-10-30T...
   [筛选] 完整请求参数: ...refresh_start_date=...&refresh_end_date=...
   ```

3. **检查后端日志**
   ```
   // 应该看到：
   [API] GET /accounts 收到请求:
     refresh_start_date=2024-09-30T...
     refresh_end_date=2024-10-30T...
   [筛选] 添加日期范围筛选: ...
   ```

**可能的问题**:

- ❌ 如果浏览器控制台没有显示日志 → 刷新页面，清除缓存
- ❌ 如果没有"添加日期范围参数"日志 → 全局变量未设置
- ❌ 如果后端收到的参数是 `None` → 前端没有正确发送参数
- ❌ 如果后端没有"添加日期范围筛选"日志 → 后端逻辑问题

### 问题2: 修改日期后点击搜索无效

**诊断步骤**:

1. **检查搜索日志**
   ```javascript
   // 应该看到：
   [搜索] 自定义模式 - 输入框值:
     起始时间输入: 2024-10-01T00:00
     截止时间输入: 2024-10-30T23:59
   [搜索] 转换为ISO格式:
     起始时间: 2024-10-01T00:00:00.000Z
     截止时间: 2024-10-30T23:59:00.000Z
   ```

**可能的问题**:

- ❌ 如果没有"自定义模式"日志 → `currentRefreshStatusFilter` 不是 `custom`
- ❌ 如果输入框值为空 → 日期选择器值丢失
- ❌ 如果看到错误日志 → 日期验证失败

### 问题3: 点击"应用筛选"无效

**诊断步骤**:

1. **检查应用筛选日志**
   ```javascript
   // 应该看到：
   [应用筛选] 开始应用自定义日期筛选...
   [应用筛选] 输入框值:
     起始时间: 2024-10-01T00:00
     截止时间: 2024-10-30T23:59
   ```

2. **检查是否有错误提示**
   - "请选择起始时间和截止时间"
   - "起始时间不能晚于截止时间"

---

## 调试流程

### 完整的调试流程

```
用户操作
   ↓
1. 打开浏览器开发者工具（F12）
   切换到Console（控制台）标签
   ↓
2. 选择"指定刷新条件"
   ↓
3. 查看浏览器控制台，应该看到：
   [筛选] 状态变化: custom
   [筛选] 设置默认日期范围: ...
   ↓
4. 修改日期（可选）
   ↓
5. 点击"应用筛选"或"搜索"
   ↓
6. 查看浏览器控制台，应该看到：
   [搜索] 或 [应用筛选] 开始...
   [搜索] 转换为ISO格式: ...
   [筛选] 添加日期范围参数: ...
   [筛选] 完整请求参数: ...
   ↓
7. 同时查看后端日志：
   tail -f logs/outlook_manager.log
   ↓
8. 应该看到：
   [API] GET /accounts 收到请求: ...
   refresh_start_date=...
   refresh_end_date=...
   [筛选] 添加日期范围筛选: ...
   [筛选] SQL WHERE子句: ...
   [筛选] 符合条件的总数: ...
```

### 快速诊断命令

**前端检查**（在浏览器控制台执行）:
```javascript
// 检查全局变量
console.log('currentRefreshStatusFilter:', currentRefreshStatusFilter);
console.log('currentRefreshStartDate:', currentRefreshStartDate);
console.log('currentRefreshEndDate:', currentRefreshEndDate);

// 检查输入框值
console.log('输入框起始时间:', document.getElementById('refreshStartDate').value);
console.log('输入框截止时间:', document.getElementById('refreshEndDate').value);
```

**后端检查**（在服务器终端执行）:
```bash
# 查看最近的筛选日志
grep "\[筛选\]" logs/outlook_manager.log | tail -20

# 查看最近的API请求
grep "\[API\] GET /accounts" logs/outlook_manager.log | tail -10

# 实时监控
tail -f logs/outlook_manager.log | grep -E "\[筛选\]|\[API\]"
```

---

## 收集问题报告

如果问题仍未解决，请收集以下信息：

### 1. 浏览器控制台日志

在浏览器控制台中，执行：
```javascript
// 清空控制台
console.clear();

// 执行操作
// 然后右键点击控制台 → "Save as..."
// 保存为 console.log
```

### 2. 后端日志

```bash
# 提取相关日志
grep -E "\[筛选\]|\[API\] GET /accounts" logs/outlook_manager.log > debug.log
```

### 3. 网络请求

在浏览器开发者工具中：
1. 切换到 Network（网络）标签
2. 执行操作
3. 找到 `/accounts` 请求
4. 右键 → Copy → Copy as cURL

### 4. 数据库状态

```bash
# 检查数据库中的账户
sqlite3 data.db "SELECT email, last_refresh_time, refresh_status FROM accounts LIMIT 10;"
```

---

## 预期的正常日志流

### 完整的正常日志示例

**前端（浏览器控制台）**:
```javascript
[筛选] 状态变化: custom
[筛选] 设置默认日期范围:
  起始时间: 2024-09-30T14:30:00.000Z
  截止时间: 2024-10-30T14:30:00.000Z
[筛选] 添加日期范围参数:
  refresh_start_date: 2024-09-30T14:30:00.000Z
  refresh_end_date: 2024-10-30T14:30:00.000Z
[筛选] 完整请求参数: page=1&page_size=10&refresh_start_date=2024-09-30T14:30:00.000Z&refresh_end_date=2024-10-30T14:30:00.000Z
```

**后端（logs/outlook_manager.log）**:
```
2024-10-30 14:30:00 - INFO - [API] GET /accounts 收到请求:
2024-10-30 14:30:00 - INFO -   page=1, page_size=10
2024-10-30 14:30:00 - INFO -   email_search=None, tag_search=None
2024-10-30 14:30:00 - INFO -   refresh_status=None, time_filter=None
2024-10-30 14:30:00 - INFO -   after_date=None
2024-10-30 14:30:00 - INFO -   refresh_start_date=2024-09-30T14:30:00.000Z
2024-10-30 14:30:00 - INFO -   refresh_end_date=2024-10-30T14:30:00.000Z
2024-10-30 14:30:00 - INFO - [筛选] 添加日期范围筛选: 2024-09-30T14:30:00.000Z 至 2024-10-30T14:30:00.000Z
2024-10-30 14:30:00 - INFO - [筛选] SQL WHERE子句: (last_refresh_time >= ? AND last_refresh_time <= ?)
2024-10-30 14:30:00 - INFO - [筛选] SQL参数: ['2024-09-30T14:30:00.000Z', '2024-10-30T14:30:00.000Z', 10, 0]
2024-10-30 14:30:00 - INFO - [筛选] 符合条件的总数: 5
2024-10-30 14:30:00 - INFO - [API] 查询结果: 总数=5, 返回=5条
```

---

## 总结

通过这些详细的日志，我们可以：

1. ✅ **追踪前端状态** - 查看全局变量是否正确设置
2. ✅ **验证参数传递** - 确认参数从前端正确发送到后端
3. ✅ **检查SQL查询** - 确认数据库查询逻辑正确执行
4. ✅ **分析结果** - 验证返回的数据是否符合预期

请按照本指南进行调试，并收集相关日志信息。如果问题仍未解决，请提供：
- 浏览器控制台完整日志
- 后端日志相关部分
- 网络请求详情
- 数据库账户状态

---

**文档创建时间**: 2024年10月30日  
**适用版本**: v2.1.0+  
**状态**: ✅ 完成

