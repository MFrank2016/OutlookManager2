# 时区配置更新说明

## 更新日期

2025-11-01

## 问题描述

用户反馈 Docker 容器中显示的时间与实际时间相差 8 小时：

- **实际时间**（东 8 区）：下午 5 点（17:00）
- **容器显示**：上午 9 点（09:00）
- **原因**：Docker 容器默认使用 UTC 时区

## 解决方案

已完成时区配置，采用**双重保障机制**确保容器使用东 8 区时间。

## 更新内容

### 1. 修改的文件

#### ✅ `docker-compose.yml`

添加了时区相关配置：

```yaml
volumes:
  # 时区配置 - 挂载宿主机时区文件
  - /etc/localtime:/etc/localtime:ro
  - /etc/timezone:/etc/timezone:ro

environment:
  # 时区设置为东8区
  - TZ=Asia/Shanghai
```

**作用**：运行时配置，无需重新构建镜像即可生效

#### ✅ `docker/Dockerfile`

添加了时区设置：

```dockerfile
ENV TZ=Asia/Shanghai

RUN apk add --no-cache tzdata \
    && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && echo "Asia/Shanghai" > /etc/timezone \
    && apk del tzdata
```

**作用**：构建时配置，镜像自带时区设置

### 2. 新增的文件

#### 📄 `docs/时区配置指南.md`

详细的时区配置文档，包含：

- 问题描述和解决方案
- 部署步骤和验证方法
- 常见问题和排查指南
- 代码示例和最佳实践

#### 📄 `scripts/verify_timezone.sh`

时区验证脚本，功能：

- 检查容器运行状态
- 验证宿主机时区
- 验证容器时区配置
- 检查 Python 时区
- 验证日志时间
- 生成详细的验证报告

#### 📄 `scripts/fix_timezone.sh`

一键修复脚本，功能：

- 自动检查和设置宿主机时区
- 备份现有配置文件
- 重新构建 Docker 镜像
- 启动容器并验证配置
- 生成修复报告

#### 📄 `docs/时区配置更新说明.md`（本文档）

更新说明文档

### 3. 更新的文档

#### 📝 `docs/Docker部署说明.md`

添加了"时区配置"章节，包含：

- 环境变量说明（新增 TZ 变量）
- 时区配置说明
- 验证和修改方法
- 问题排查指南

## 使用方法

### 方法 1：自动修复（推荐）

在服务器上运行：

```bash
# 进入项目目录
cd /path/to/OutlookManager2

# 给脚本添加执行权限
chmod +x scripts/fix_timezone.sh
chmod +x scripts/verify_timezone.sh

# 运行修复脚本
bash scripts/fix_timezone.sh
```

脚本会自动完成：

1. ✅ 检查宿主机时区
2. ✅ 停止现有容器
3. ✅ 备份配置文件
4. ✅ 重新构建镜像
5. ✅ 启动容器
6. ✅ 验证时区配置

### 方法 2：手动操作

```bash
# 1. 确保宿主机时区正确
sudo timedatectl set-timezone Asia/Shanghai

# 2. 停止容器
docker-compose down

# 3. 重新构建镜像
docker-compose build --no-cache

# 4. 启动容器
docker-compose up -d

# 5. 验证时区
docker exec outlook-email-api date
```

### 方法 3：快速验证

如果只想验证当前时区配置：

```bash
# 运行验证脚本
bash scripts/verify_timezone.sh
```

## 验证结果

正确配置后，应该看到：

```bash
$ docker exec outlook-email-api date
Sat Nov  1 17:00:00 CST 2025

$ docker exec outlook-email-api sh -c 'echo $TZ'
Asia/Shanghai

$ docker exec outlook-email-api python -c "import datetime; print(datetime.datetime.now())"
2025-11-01 17:00:00.123456
```

## 前端显示

配置完成后：

1. 清除浏览器缓存
2. 硬刷新页面（Ctrl+Shift+R 或 Cmd+Shift+R）
3. 检查显示的时间是否为东 8 区时间

## 技术细节

### 时区配置层级

1. **操作系统层**：

   - `/etc/localtime` - 系统时区文件
   - `/etc/timezone` - 时区名称
   - `TZ` 环境变量

2. **Python 层**：

   - `datetime.now()` 使用系统时区
   - 可通过 `pytz` 库处理时区转换

3. **前端层**：
   - JavaScript `Date` 对象使用浏览器时区
   - 可通过 `Intl.DateTimeFormat` 格式化显示

### 时区优先级

```
TZ环境变量 > /etc/localtime > /etc/timezone
```

### Alpine Linux 特殊说明

项目使用 `python:3.11-alpine3.21` 基础镜像：

- Alpine 默认不包含时区数据
- 需要安装 `tzdata` 包
- 安装后可以删除以减小镜像体积

## 兼容性

- ✅ Debian 12
- ✅ Ubuntu 20.04+
- ✅ CentOS 7+
- ✅ Alpine Linux 3.x
- ✅ Docker 20.10+
- ✅ Docker Compose 1.29+

## 注意事项

### 1. 数据库时间

- 已存在的数据库记录时间不会自动转换
- 新写入的数据会使用新时区
- 建议在应用层统一使用 UTC 存储，显示时转换

### 2. 日志时间

- 日志文件的时间戳会使用新时区
- 旧日志的时间戳不会改变
- 可能需要注意日志分析时的时区问题

### 3. 定时任务

- 后台定时任务（如邮件同步、Token 刷新）会使用新时区
- 确保定时任务的执行时间符合预期

### 4. API 时间格式

建议 API 返回时间时使用 ISO 8601 格式，包含时区信息：

```
2025-11-01T17:00:00+08:00  # 推荐
```

## 回滚方案

如果需要回滚到 UTC 时区：

```bash
# 1. 修改 docker-compose.yml
# 将 TZ=Asia/Shanghai 改为 TZ=UTC

# 2. 修改 Dockerfile
# 将 Asia/Shanghai 改为 UTC

# 3. 重新构建和启动
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

## 常见问题

### Q: 修改后前端时间仍然不对？

**A**: 清除浏览器缓存并硬刷新页面，或者检查前端 JavaScript 是否有时区转换逻辑。

### Q: 宿主机没有 /etc/localtime 文件？

**A**: 注释掉 docker-compose.yml 中的卷挂载，仅依赖 Dockerfile 中的时区配置。

### Q: 不同服务器需要不同时区？

**A**: 在 docker-compose.yml 中为不同服务设置不同的 TZ 环境变量。

### Q: 如何验证时区配置是否生效？

**A**: 运行 `bash scripts/verify_timezone.sh` 获取详细的验证报告。

## 相关文档

- [时区配置指南](./时区配置指南.md) - 详细配置文档
- [Docker 部署说明](./Docker部署说明.md) - Docker 部署文档
- [快速开始](./QUICK_START.md) - 快速开始指南

## 技术支持

如遇问题，请：

1. 查看验证脚本输出：`bash scripts/verify_timezone.sh`
2. 查看容器日志：`docker-compose logs -f`
3. 查看应用日志：`tail -f logs/outlook_manager.log`
4. 参考详细文档：`docs/时区配置指南.md`

## 更新历史

| 日期       | 版本   | 说明             |
| ---------- | ------ | ---------------- |
| 2025-11-01 | v2.0.1 | 添加时区配置支持 |
| 2025-11-01 | v2.0.0 | 初始版本         |

---

**维护者**: Outlook Manager Team  
**最后更新**: 2025-11-01
