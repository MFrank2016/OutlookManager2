# 邮件缓存改进 - 快速参考指南

## 🎯 核心问题

| 问题 | 影响 | 优先级 |
|------|------|--------|
| SQLite缓存无过期机制 | 可能返回过期数据 | 🔴 紧急 |
| 缺少关键索引 | 搜索和过滤慢 | 🔴 紧急 |
| 无自动清理机制 | 数据库无限增长 | 🔴 紧急 |
| 缺少大小限制 | 占用过多磁盘 | 🟡 重要 |
| 无LRU策略 | 缓存效率低 | 🟡 重要 |

## 🚀 快速实施（1-2周）

### 1. 添加过期时间字段

```sql
-- 执行迁移
sqlite3 data.db

ALTER TABLE emails_cache ADD COLUMN expires_at TEXT;
ALTER TABLE emails_cache ADD COLUMN updated_at TEXT;
ALTER TABLE email_details_cache ADD COLUMN expires_at TEXT;
ALTER TABLE email_details_cache ADD COLUMN updated_at TEXT;

CREATE INDEX idx_emails_cache_expires ON emails_cache(expires_at);
CREATE INDEX idx_email_details_cache_expires ON email_details_cache(expires_at);

.quit
```

### 2. 添加性能索引

```sql
sqlite3 data.db

CREATE INDEX idx_emails_cache_folder ON emails_cache(folder);
CREATE INDEX idx_emails_cache_from_email ON emails_cache(from_email);
CREATE INDEX idx_emails_cache_account_folder ON emails_cache(email_account, folder);

.quit
```

### 3. 添加配置

```python
# config.py
SQLITE_CACHE_EXPIRE_TIME = 3600  # 1小时
EMAIL_DETAILS_CACHE_EXPIRE_TIME = 7200  # 2小时
MAX_CACHE_SIZE_MB = 500  # 最大500MB
```

### 4. 添加清理任务

```python
# requirements.txt
APScheduler==3.10.4

# main.py
from apscheduler.schedulers.background import BackgroundScheduler

scheduler = BackgroundScheduler()
scheduler.add_job(db.clean_expired_cache, 'interval', hours=1)
scheduler.start()
```

## 📊 预期效果

- ✅ 缓存命中率: 60% → 85% (+42%)
- ✅ 首次加载: 2-3秒 → 0.3-0.5秒 (+80%)
- ✅ 搜索速度: 500-800ms → 100-200ms (+75%)
- ✅ 数据库大小: 无限 → <500MB (受控)

## 🔍 验证方法

```bash
# 1. 检查索引
sqlite3 data.db "SELECT name FROM sqlite_master WHERE type='index';"

# 2. 检查字段
sqlite3 data.db "PRAGMA table_info(emails_cache);"

# 3. 检查缓存大小
sqlite3 data.db "SELECT COUNT(*) FROM emails_cache;"
sqlite3 data.db "SELECT COUNT(*) FROM email_details_cache;"

# 4. 检查过期缓存
sqlite3 data.db "SELECT COUNT(*) FROM emails_cache WHERE expires_at < datetime('now');"
```

## 📚 完整文档

详见: `docs/邮件缓存设计分析与改进建议.md`

---

**更新日期**: 2025-11-01
