# Docker 容器时区配置指南

## 问题描述

Docker 容器默认使用 UTC 时区（格林威治标准时间），导致显示的时间与中国东 8 区时间相差 8 小时。

**现象**：

- 中国时间：下午 5 点（17:00）
- 容器显示：上午 9 点（09:00）
- 时差：8 小时

## 解决方案

本项目已配置**双重时区设置**，确保容器使用东 8 区时间（Asia/Shanghai）。

### 方案 1：docker-compose.yml 配置（运行时）

通过环境变量和卷挂载设置时区：

```yaml
volumes:
  # 挂载宿主机时区文件（只读）
  - /etc/localtime:/etc/localtime:ro
  - /etc/timezone:/etc/timezone:ro

environment:
  # 设置时区环境变量
  - TZ=Asia/Shanghai
```

**优点**：

- ✅ 无需重新构建镜像
- ✅ 可以灵活切换时区
- ✅ 与宿主机时区保持一致

### 方案 2：Dockerfile 配置（构建时）

在镜像构建时安装时区数据并设置：

```dockerfile
ENV TZ=Asia/Shanghai

RUN apk add --no-cache tzdata \
    && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && echo "Asia/Shanghai" > /etc/timezone \
    && apk del tzdata
```

**优点**：

- ✅ 镜像自带时区配置
- ✅ 不依赖宿主机时区文件
- ✅ 适合分发镜像

## 部署步骤

### 1. 确保宿主机时区正确

在 Debian 12 服务器上检查和设置时区：

```bash
# 查看当前时区
timedatectl

# 如果不是Asia/Shanghai，设置为东8区
sudo timedatectl set-timezone Asia/Shanghai

# 验证时区
date
```

### 2. 重新构建并启动容器

```bash
# 停止现有容器
docker-compose down

# 重新构建镜像（包含时区配置）
docker-compose build --no-cache

# 启动容器
docker-compose up -d

# 查看日志
docker-compose logs -f
```

### 3. 验证时区配置

```bash
# 进入容器
docker exec -it outlook-email-api sh

# 查看容器时区
date
echo $TZ
cat /etc/timezone
ls -l /etc/localtime

# 查看Python时区
python -c "import datetime; print(datetime.datetime.now())"

# 退出容器
exit
```

## 验证结果

正确配置后，应该看到：

```bash
# 容器内执行 date 命令
$ date
Sat Nov  1 17:00:00 CST 2025

# Python时间
$ python -c "import datetime; print(datetime.datetime.now())"
2025-11-01 17:00:00.123456

# 时区环境变量
$ echo $TZ
Asia/Shanghai

# 时区文件
$ cat /etc/timezone
Asia/Shanghai
```

## 快速验证脚本

使用以下命令快速验证时区配置：

```bash
# 一键验证脚本
docker exec outlook-email-api sh -c '
echo "=== 容器时区验证 ==="
echo "1. 系统时间: $(date)"
echo "2. 时区变量: $TZ"
echo "3. 时区文件: $(cat /etc/timezone 2>/dev/null || echo "未找到")"
echo "4. Python时间: $(python -c "import datetime; print(datetime.datetime.now())")"
echo "5. 时区偏移: $(date +%z)"
echo "===================="
'
```

## 常见问题

### Q1: 修改后时间仍然不对？

**解决方法**：

1. 确保已重新构建镜像：`docker-compose build --no-cache`
2. 确保已重启容器：`docker-compose restart`
3. 清除浏览器缓存并刷新前端页面

### Q2: 宿主机没有 /etc/localtime 文件？

**解决方法**：
注释掉 docker-compose.yml 中的卷挂载，仅依赖 Dockerfile 中的时区配置：

```yaml
volumes:
  # - /etc/localtime:/etc/localtime:ro  # 注释掉
  # - /etc/timezone:/etc/timezone:ro    # 注释掉
```

### Q3: 不同时区如何配置？

**修改时区**：

- 北京时间（东 8 区）：`Asia/Shanghai`
- 东京时间（东 9 区）：`Asia/Tokyo`
- 纽约时间（西 5 区）：`America/New_York`
- 伦敦时间（0 时区）：`Europe/London`

修改 `docker-compose.yml` 和 `Dockerfile` 中的 `TZ` 环境变量即可。

### Q4: 数据库中的时间也会更新吗？

**说明**：

- ✅ 新写入的数据会使用新时区
- ❌ 已存在的数据不会自动转换
- 💡 Python 的 `datetime.now()` 会使用容器时区
- 💡 日志文件的时间戳会使用新时区

### Q5: 前端显示时间仍然不对？

**可能原因**：

1. 浏览器缓存：清除缓存并硬刷新（Ctrl+Shift+R）
2. 前端时区处理：检查前端 JavaScript 是否有时区转换逻辑
3. API 返回时间格式：确认后端返回的时间格式

**检查前端时区**：
打开浏览器控制台执行：

```javascript
console.log(new Date());
console.log(Intl.DateTimeFormat().resolvedOptions().timeZone);
```

## 时区配置最佳实践

### ✅ 推荐做法

1. **统一使用 UTC 存储**：数据库中存储 UTC 时间
2. **前端转换显示**：在前端根据用户时区显示
3. **后端明确时区**：API 返回时间时包含时区信息（ISO 8601 格式）
4. **容器时区一致**：所有容器使用相同时区，便于日志分析

### 📝 ISO 8601 时间格式示例

```python
# 推荐：带时区信息的ISO格式
"2025-11-01T17:00:00+08:00"  # 东8区
"2025-11-01T09:00:00Z"       # UTC时间

# 不推荐：不带时区信息
"2025-11-01 17:00:00"        # 无法确定时区
```

## 代码示例

### Python 后端时区处理

```python
from datetime import datetime, timezone
import pytz

# 获取东8区时间
tz_shanghai = pytz.timezone('Asia/Shanghai')
now_shanghai = datetime.now(tz_shanghai)
print(f"上海时间: {now_shanghai}")

# 转换为UTC
now_utc = now_shanghai.astimezone(timezone.utc)
print(f"UTC时间: {now_utc}")

# ISO格式输出（推荐）
iso_format = now_shanghai.isoformat()
print(f"ISO格式: {iso_format}")
```

### JavaScript 前端时区处理

```javascript
// 获取当前时区
const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
console.log("用户时区:", userTimeZone);

// 格式化显示时间
const date = new Date("2025-11-01T09:00:00Z"); // UTC时间
const options = {
  timeZone: "Asia/Shanghai",
  year: "numeric",
  month: "2-digit",
  day: "2-digit",
  hour: "2-digit",
  minute: "2-digit",
  second: "2-digit",
};
console.log("东8区时间:", date.toLocaleString("zh-CN", options));
```

## 监控和日志

### 日志时间戳验证

查看日志文件中的时间戳是否正确：

```bash
# 查看最新日志
docker-compose logs --tail=50 outlook-email-client

# 查看日志文件
tail -f logs/outlook_manager.log
```

正确的日志时间戳示例：

```
2025-11-01 17:00:00,123 - INFO - Email sync background task started
```

## 总结

本项目已完成时区配置，采用**双重保障**：

1. ✅ **Dockerfile 层面**：镜像构建时设置时区
2. ✅ **docker-compose 层面**：运行时挂载时区文件和环境变量

只需重新构建并启动容器即可生效，无需修改应用代码。

---

**更新时间**: 2025-11-01  
**适用版本**: v2.0.0+  
**维护者**: Outlook Manager Team
