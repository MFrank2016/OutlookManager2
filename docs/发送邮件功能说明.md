# 发送邮件功能说明

## 功能概述

在邮箱账号管理列表的操作栏中增加了发送邮件按钮，支持通过富文本编辑器撰写和发送邮件。

## 新增文件

### 1. 前端模板
- `static/templates/modals/send_email.html` - 发送邮件模态框

### 2. JavaScript 文件
- `static/js/send-email.js` - 发送邮件逻辑

### 3. CSS 样式
- `static/css/send-email.css` - 发送邮件模态框样式（含响应式设计）

## 修改文件

### 1. `static/js/accounts.js`
- 在账户列表操作栏添加"发送邮件"按钮
- 根据账户的 `api_method` 字段判断是否支持发送邮件
- 添加 Graph API 检测和启用功能
- 添加友好的提示信息

### 2. `static/css/accounts.css`
- 更新移动端按钮标签（第 2 个按钮为"发送"）

### 3. `static/templates/base.html`
- 引入 Quill.js 富文本编辑器（CSS 和 JS）
- 引入 `send_email.html` 模态框
- 引入 `send-email.css` 样式文件
- 引入 `send-email.js` 脚本文件

## 功能特性

### 1. 富文本编辑器 (Quill.js)

支持以下格式化选项：
- 📝 标题样式（H1, H2, H3）
- **粗体**、*斜体*、<u>下划线</u>、~~删除线~~
- 🎨 文字颜色和背景色
- 📋 有序列表和无序列表
- ↔️ 文本缩进
- ⚖️ 文本对齐
- 🔗 链接插入
- 🧹 清除格式

### 2. 表单验证

- ✅ 收件人邮箱格式验证
- ✅ 必填字段检查（收件人、主题、内容）
- ✅ 防止重复提交（发送中禁用按钮）

### 3. Graph API 检测

发送邮件功能**仅支持 Graph API**，系统会自动检测账户的 API 方法：

#### 如果账户支持 Graph API：
- 显示绿色的"发送邮件"按钮（✉️）
- 点击后直接打开发送邮件模态框

#### 如果账户使用 IMAP：
- 显示灰色的"发送邮件"按钮（半透明）
- 点击后显示提示信息，引导用户启用 Graph API
- 提供"检测并启用 Graph API"按钮

### 4. 响应式设计

完整的移动端适配：

#### 平板设备（≤1024px）
- 调整模态框宽度为 700px
- 优化编辑器高度

#### 手机设备（≤768px）
- 模态框宽度 95%
- 发件人信息垂直排列
- 编辑器工具栏紧凑布局
- 按钮全宽显示，垂直排列

#### 小屏手机（≤480px）
- 模态框宽度 98%
- 进一步压缩编辑器高度
- 工具栏按钮更紧凑

## 使用流程

### 1. 启用 Graph API（首次使用）

对于使用 IMAP 的账户：

1. 点击账户列表中的"发送邮件"按钮
2. 系统显示提示信息
3. 点击"检测并启用 Graph API"按钮
4. 系统自动检测并更新账户的 API 方法
5. 刷新后即可使用发送邮件功能

**注意**：账户需要具有以下 Microsoft Graph API 权限：
- `Mail.ReadWrite` - 读写邮件
- `Mail.Send` - 发送邮件

### 2. 发送邮件

1. 在账户列表中点击绿色的"发送邮件"按钮（✉️）
2. 填写收件人邮箱地址
3. 填写邮件主题
4. 使用富文本编辑器编辑邮件内容
5. 点击"发送"按钮

## API 端点

### 发送邮件
```
POST /emails/{email_id}/send
```

**请求体**：
```json
{
  "to": "recipient@example.com",
  "subject": "邮件主题",
  "body_text": "纯文本内容",
  "body_html": "<p>HTML格式内容</p>"
}
```

**响应**：
```json
{
  "success": true,
  "message": "Email sent successfully",
  "message_id": "AAMkAGI..."
}
```

### 检测 API 方法
```
POST /accounts/{email_id}/detect-api-method
```

**响应**：
```json
{
  "email_id": "user@outlook.com",
  "api_method": "graph_api",
  "message": "API method detected and updated to: graph_api"
}
```

## 技术实现

### 1. 前端技术栈
- **Quill.js 1.3.6** - 富文本编辑器
- **原生 JavaScript** - 逻辑处理
- **CSS3** - 样式和响应式设计

### 2. 后端集成
- 使用现有的 `/emails/{email_id}/send` API 端点
- 自动检测账户的 `api_method` 字段
- 仅支持 Graph API 账户发送邮件

### 3. 权限控制
- 需要 `Permission.SEND_EMAILS` 权限
- 需要账户访问权限验证

## 错误处理

### 常见错误及解决方案

#### 1. "Sending email is only supported via Graph API"
**原因**：账户使用 IMAP 方式，不支持发送邮件  
**解决**：点击"检测并启用 Graph API"按钮

#### 2. "该账户不支持 Graph API"
**原因**：账户没有配置正确的 Microsoft Graph API 权限  
**解决**：
1. 检查 Azure AD 应用注册
2. 确保添加了 `Mail.ReadWrite` 和 `Mail.Send` 权限
3. 确保已授予管理员同意

#### 3. 邮箱格式错误
**原因**：收件人邮箱地址格式不正确  
**解决**：输入有效的邮箱地址（如：user@example.com）

## 深色模式支持

CSS 文件包含深色模式支持（基于系统偏好设置）：
```css
@media (prefers-color-scheme: dark) {
  /* 深色模式样式 */
}
```

## 未来扩展

可能的功能扩展：
- [ ] 支持多个收件人（CC、BCC）
- [ ] 附件上传功能
- [ ] 邮件模板保存
- [ ] 草稿自动保存
- [ ] 邮件签名
- [ ] 延迟发送
- [ ] 邮件撤回

## 注意事项

1. **Graph API 依赖**：发送邮件功能完全依赖 Microsoft Graph API，IMAP 协议不支持发送邮件
2. **权限要求**：确保 Azure AD 应用具有必要的 API 权限
3. **速率限制**：注意 Microsoft Graph API 的速率限制
4. **HTML 内容**：编辑器生成的 HTML 会自动发送，无需手动转换
5. **CDN 依赖**：Quill.js 从 CDN 加载，需要网络连接

## 更新日期

2025-11-05

