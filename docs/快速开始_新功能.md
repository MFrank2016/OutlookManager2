# 快速开始：新功能使用指南

## 一、获取API Key

系统启动后会自动生成API Key。有两种方式查看：

### 方式1：查看启动日志（推荐）

启动服务器时会在控制台显示：

```
系统API Key: Ssb2rXHc-5GJPmDlIizr8U-OKIXvi0ZVG86QFj4LYYY
使用方式: 在请求头中添加 X-API-Key: Ssb2rXHc-5GJPmDlIizr8U-OKIXvi0ZVG86QFj4LYYY
```

### 方式2：查询数据库

```python
import sqlite3
conn = sqlite3.connect("data.db")
cursor = conn.cursor()
cursor.execute("SELECT value FROM system_config WHERE key = 'api_key'")
api_key = cursor.fetchone()[0]
print(f"API Key: {api_key}")
conn.close()
```

## 二、5分钟快速上手

### 示例1：使用API Key获取账户列表

```python
import requests

API_KEY = "你的API_KEY"
headers = {"X-API-Key": API_KEY}

# 获取所有账户
response = requests.get("http://localhost:8000/accounts", headers=headers)
print(response.json())
```

### 示例2：随机获取一个邮箱账户

```python
import requests

API_KEY = "你的API_KEY"
headers = {"X-API-Key": API_KEY}

# 随机获取1个账户
response = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={"page_size": 1}
)

accounts = response.json()["accounts"]
if accounts:
    email = accounts[0]["email_id"]
    print(f"随机选中的邮箱: {email}")
else:
    print("没有可用的账户")
```

### 示例3：为账户添加标签

```python
import requests

API_KEY = "你的API_KEY"
headers = {
    "X-API-Key": API_KEY,
    "Content-Type": "application/json"
}

# 为账户添加"VIP"标签
email = "user@outlook.com"
response = requests.post(
    f"http://localhost:8000/accounts/{email}/tags/add",
    headers=headers,
    json={"tag": "VIP"}
)

print(response.json()["message"])
```

## 三、常见使用场景

### 场景1：随机分配邮箱给任务

```python
import requests

API_KEY = "你的API_KEY"
headers = {"X-API-Key": API_KEY, "Content-Type": "application/json"}

# 1. 随机获取一个可用邮箱（排除已使用的）
response = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={
        "exclude_tags": "使用中,禁用",
        "page_size": 1
    }
)

accounts = response.json()["accounts"]
if not accounts:
    print("没有可用的邮箱")
    exit()

email = accounts[0]["email_id"]
print(f"分配邮箱: {email}")

# 2. 标记为使用中
requests.post(
    f"http://localhost:8000/accounts/{email}/tags/add",
    headers=headers,
    json={"tag": "使用中"}
)

# 3. 执行任务...
print(f"正在使用 {email} 执行任务...")

# 4. 任务完成后可以移除标签（使用现有的更新标签接口）
```

### 场景2：按标签批量处理

```python
import requests

API_KEY = "你的API_KEY"
headers = {"X-API-Key": API_KEY, "Content-Type": "application/json"}

# 获取所有"待处理"的账户
response = requests.get(
    "http://localhost:8000/accounts/random",
    headers=headers,
    params={
        "include_tags": "待处理",
        "page_size": 100
    }
)

accounts = response.json()["accounts"]
print(f"找到 {len(accounts)} 个待处理账户")

# 批量处理
for account in accounts:
    email = account["email_id"]
    
    # 处理账户...
    print(f"处理 {email}...")
    
    # 添加"已处理"标签
    requests.post(
        f"http://localhost:8000/accounts/{email}/tags/add",
        headers=headers,
        json={"tag": "已处理"}
    )
```

### 场景3：根据标签筛选和统计

```python
import requests

API_KEY = "你的API_KEY"
headers = {"X-API-Key": API_KEY}

# 统计各类账户数量
categories = {
    "工作邮箱": {"include_tags": "工作"},
    "个人邮箱": {"include_tags": "个人"},
    "VIP邮箱": {"include_tags": "VIP"},
    "可用邮箱": {"exclude_tags": "禁用,过期"}
}

for name, params in categories.items():
    response = requests.get(
        "http://localhost:8000/accounts/random",
        headers=headers,
        params={**params, "page_size": 1}
    )
    count = response.json()["total_accounts"]
    print(f"{name}: {count} 个")
```

## 四、命令行快速测试

### 测试API Key认证

```bash
# Windows PowerShell
$API_KEY = "你的API_KEY"
Invoke-WebRequest -Uri "http://localhost:8000/accounts" `
  -Headers @{"X-API-Key"=$API_KEY} | Select-Object -ExpandProperty Content

# Linux/Mac
API_KEY="你的API_KEY"
curl -H "X-API-Key: $API_KEY" http://localhost:8000/accounts
```

### 测试随机获取邮箱

```bash
# Windows PowerShell
Invoke-WebRequest -Uri "http://localhost:8000/accounts/random?page_size=1" `
  -Headers @{"X-API-Key"=$API_KEY} | Select-Object -ExpandProperty Content

# Linux/Mac
curl -H "X-API-Key: $API_KEY" \
  "http://localhost:8000/accounts/random?page_size=1"
```

### 测试添加标签

```bash
# Windows PowerShell
$body = @{tag="测试标签"} | ConvertTo-Json
Invoke-WebRequest -Uri "http://localhost:8000/accounts/user@outlook.com/tags/add" `
  -Method POST `
  -Headers @{"X-API-Key"=$API_KEY; "Content-Type"="application/json"} `
  -Body $body | Select-Object -ExpandProperty Content

# Linux/Mac
curl -X POST \
  -H "X-API-Key: $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"tag":"测试标签"}' \
  "http://localhost:8000/accounts/user@outlook.com/tags/add"
```

## 五、故障排查

### 问题1：401 未授权错误

**原因**: API Key不正确或未提供

**解决**:
1. 检查API Key是否正确
2. 确认请求头格式：`X-API-Key: YOUR_API_KEY`
3. 查看数据库中的API Key是否与使用的一致

### 问题2：随机接口返回空列表

**原因**: 没有符合筛选条件的账户

**解决**:
1. 检查筛选条件是否过于严格
2. 不使用筛选条件测试是否有账户
3. 查看数据库中账户的标签设置

### 问题3：添加标签返回404

**原因**: 账户不存在

**解决**:
1. 检查邮箱地址拼写
2. 使用 GET /accounts 接口确认账户是否存在
3. 确保邮箱地址正确编码（URL编码）

## 六、下一步

- 查看 [新功能使用说明.md](./新功能使用说明.md) 了解详细文档
- 访问 http://localhost:8000/docs 查看完整API文档
- 运行 `python test_new_features.py` 进行自动化测试

## 七、最佳实践

1. **安全存储API Key**: 使用环境变量，不要硬编码在代码中
2. **错误处理**: 始终检查响应状态码和错误信息
3. **合理分页**: 根据实际需求设置合适的page_size
4. **标签规范**: 建立统一的标签命名规范
5. **幂等操作**: 利用添加标签接口的幂等性，避免重复检查

## 八、技术支持

如有问题，请查看：
- 服务器日志: `logs/outlook_manager.log`
- API文档: http://localhost:8000/docs
- 更新日志: `CHANGELOG.md`

