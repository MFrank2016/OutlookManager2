# 邮箱账户管理筛选功能优化说明

## 更新时间
2024年10月30日

## 更新概述

优化了邮箱账户管理页面的筛选功能，特别是刷新状态筛选器，新增了**指定刷新条件**功能，支持按日期时间范围筛选账户。

---

## 主要更新内容

### 1. 状态筛选选项优化 ✨

将原有的筛选选项调整为更清晰的5个选项：

| 选项 | 说明 | 用途 |
|------|------|------|
| **全部状态** | 显示所有账户 | 查看所有账户，不做任何筛选 |
| **从未刷新** | 从未刷新过Token的账户 | 找出新添加但未验证的账户 |
| **刷新失败** | 上次刷新失败的账户 | 找出需要修复的问题账户 |
| **刷新成功** | 上次刷新成功的账户 | 查看正常工作的账户 |
| **指定刷新条件** ⭐ | 按日期时间范围筛选 | 精准查找特定时间段刷新的账户 |

### 2. 指定刷新条件功能 ⭐

当选择"指定刷新条件"时，会展示日期时间选择器，支持：

#### 功能特性

- ✅ **刷新起始时间** - 指定开始的日期时间
- ✅ **刷新截止时间** - 指定结束的日期时间
- ✅ **智能默认值** - 自动设置为30天前至当前时间
- ✅ **时间验证** - 自动检查起始时间不能晚于截止时间
- ✅ **友好提示** - 提供必填项检查和错误提示

#### 使用场景

1. **查找最近刷新的账户**
   - 起始时间：24小时前
   - 截止时间：当前时间
   - 用途：查看今天刷新过的账户

2. **查找特定时间段的账户**
   - 起始时间：2024-10-01 00:00
   - 截止时间：2024-10-07 23:59
   - 用途：查看本周刷新的账户

3. **批量刷新特定时间段**
   - 设置时间范围后点击"批量刷新Token"
   - 只刷新该时间段内刷新过的账户
   - 用途：重新验证特定批次的账户

---

## 技术实现

### 前端更新 (`static/index.html`)

#### 1. UI组件

**新增选项**
```html
<select id="refreshStatusFilter" class="form-control" onchange="handleRefreshStatusChange()">
    <option value="all">全部状态</option>
    <option value="never_refreshed">从未刷新</option>
    <option value="failed">刷新失败</option>
    <option value="success">刷新成功</option>
    <option value="custom">指定刷新条件</option>
</select>
```

**日期时间选择器**
```html
<div id="customDateRangeContainer" class="flex gap-3 mb-4" style="display: none;">
    <div class="flex-1">
        <label>刷新起始时间</label>
        <input type="datetime-local" id="refreshStartDate" class="form-control">
    </div>
    <div class="flex-1">
        <label>刷新截止时间</label>
        <input type="datetime-local" id="refreshEndDate" class="form-control">
    </div>
    <div>
        <button class="btn btn-info" onclick="applyCustomDateFilter()">
            应用筛选
        </button>
    </div>
</div>
```

#### 2. JavaScript函数

**新增函数**

1. **`handleRefreshStatusChange()`** - 处理状态筛选器变化
   ```javascript
   function handleRefreshStatusChange() {
       const refreshStatus = document.getElementById('refreshStatusFilter').value;
       
       if (refreshStatus === 'custom') {
           // 显示日期选择器
           document.getElementById('customDateRangeContainer').style.display = 'flex';
           
           // 设置默认值：30天前到现在
           const now = new Date();
           const startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
           
           document.getElementById('refreshStartDate').value = formatDateTimeLocal(startDate);
           document.getElementById('refreshEndDate').value = formatDateTimeLocal(now);
       } else {
           // 隐藏日期选择器，立即执行搜索
           document.getElementById('customDateRangeContainer').style.display = 'none';
           searchAccounts();
       }
   }
   ```

2. **`applyCustomDateFilter()`** - 应用自定义日期筛选
   ```javascript
   function applyCustomDateFilter() {
       const startDateInput = document.getElementById('refreshStartDate').value;
       const endDateInput = document.getElementById('refreshEndDate').value;
       
       // 验证输入
       if (!startDateInput || !endDateInput) {
           alert('请选择起始时间和截止时间');
           return;
       }
       
       const startDate = new Date(startDateInput);
       const endDate = new Date(endDateInput);
       
       if (startDate > endDate) {
           alert('起始时间不能晚于截止时间');
           return;
       }
       
       // 转换为ISO格式并执行搜索
       currentRefreshStartDate = startDate.toISOString();
       currentRefreshEndDate = endDate.toISOString();
       loadAccounts(1);
   }
   ```

3. **`formatDateTimeLocal(date)`** - 格式化日期时间
   ```javascript
   function formatDateTimeLocal(date) {
       const year = date.getFullYear();
       const month = String(date.getMonth() + 1).padStart(2, '0');
       const day = String(date.getDate()).padStart(2, '0');
       const hours = String(date.getHours()).padStart(2, '0');
       const minutes = String(date.getMinutes()).padStart(2, '0');
       return `${year}-${month}-${day}T${hours}:${minutes}`;
   }
   ```

**更新现有函数**

1. **`loadAccounts()`** - 支持日期范围参数
   ```javascript
   // 添加自定义日期范围参数
   if (currentRefreshStatusFilter === 'custom' && currentRefreshStartDate && currentRefreshEndDate) {
       params.append('refresh_start_date', currentRefreshStartDate);
       params.append('refresh_end_date', currentRefreshEndDate);
   }
   ```

2. **`searchAccounts()`** - 智能清除日期范围
   ```javascript
   if (currentRefreshStatusFilter !== 'custom') {
       currentRefreshStartDate = '';
       currentRefreshEndDate = '';
   }
   ```

3. **`clearSearch()`** - 重置日期选择
   ```javascript
   document.getElementById('refreshStartDate').value = '';
   document.getElementById('refreshEndDate').value = '';
   document.getElementById('customDateRangeContainer').style.display = 'none';
   currentRefreshStartDate = '';
   currentRefreshEndDate = '';
   ```

4. **`showBatchRefreshDialog()`** - 批量刷新支持日期范围
   ```javascript
   if (currentRefreshStatusFilter === 'custom') {
       const startDate = new Date(currentRefreshStartDate);
       const endDate = new Date(currentRefreshEndDate);
       filterDesc.push(`刷新时间在 ${startDate.toLocaleString('zh-CN')} 至 ${endDate.toLocaleString('zh-CN')} 之间`);
   }
   ```

#### 3. 全局变量

```javascript
let currentRefreshStartDate = '';
let currentRefreshEndDate = '';
```

### 后端更新

#### 1. `database.py` - 数据库查询

**更新函数签名**
```python
def get_accounts_by_filters(
    page: int = 1,
    page_size: int = 10,
    email_search: Optional[str] = None,
    tag_search: Optional[str] = None,
    refresh_status: Optional[str] = None,
    time_filter: Optional[str] = None,
    after_date: Optional[str] = None,
    refresh_start_date: Optional[str] = None,  # 新增
    refresh_end_date: Optional[str] = None      # 新增
) -> Tuple[List[Dict[str, Any]], int]:
```

**新增日期范围筛选逻辑**
```python
# 自定义日期范围筛选（指定刷新条件）
if refresh_start_date and refresh_end_date:
    conditions.append("(last_refresh_time >= ? AND last_refresh_time <= ?)")
    params.append(refresh_start_date)
    params.append(refresh_end_date)
```

#### 2. `main.py` - API端点

**更新 `GET /accounts` 端点**
```python
@app.get("/accounts", response_model=AccountListResponse, tags=["账户管理"])
async def get_accounts(
    # ... 其他参数 ...
    refresh_status: Optional[str] = Query(None, description="刷新状态筛选 (all, never_refreshed, success, failed, pending, custom)"),
    refresh_start_date: Optional[str] = Query(None, description="刷新起始日期（ISO格式，用于自定义日期范围）"),
    refresh_end_date: Optional[str] = Query(None, description="刷新截止日期（ISO格式，用于自定义日期范围）"),
    # ...
):
    accounts_data, total_accounts = db.get_accounts_by_filters(
        # ... 其他参数 ...
        refresh_start_date=refresh_start_date,
        refresh_end_date=refresh_end_date,
    )
```

**更新 `POST /accounts/batch-refresh-tokens` 端点**
```python
@app.post("/accounts/batch-refresh-tokens", ...)
async def batch_refresh_tokens(
    # ... 其他参数 ...
    refresh_start_date: Optional[str] = Query(None, description="刷新起始日期（ISO格式，用于自定义日期范围）"),
    refresh_end_date: Optional[str] = Query(None, description="刷新截止日期（ISO格式，用于自定义日期范围）"),
    # ...
):
    accounts_data, total_accounts = db.get_accounts_by_filters(
        # ... 其他参数 ...
        refresh_start_date=refresh_start_date,
        refresh_end_date=refresh_end_date,
    )
```

---

## 使用示例

### 示例 1：查找最近7天刷新的账户

1. 选择状态筛选器："指定刷新条件"
2. 系统自动显示日期选择器，默认30天前到现在
3. 修改起始时间为 7 天前
4. 点击"应用筛选"按钮
5. 查看筛选结果

### 示例 2：批量刷新特定时间段的失败账户

1. 先选择"刷新失败"查看所有失败的账户
2. 改选"指定刷新条件"
3. 设置时间范围（如：2024-10-01 到 2024-10-07）
4. 点击"应用筛选"
5. 点击"批量刷新Token"按钮
6. 确认批量刷新操作

### 示例 3：导出特定时间段的账户

1. 选择"指定刷新条件"
2. 设置需要导出的时间范围
3. 点击"应用筛选"
4. （未来功能）点击"导出账户列表"

---

## 数据流程

```
用户操作
   ↓
选择"指定刷新条件"
   ↓
handleRefreshStatusChange() 显示日期选择器
   ↓
用户选择起始和截止时间
   ↓
applyCustomDateFilter() 验证并转换日期
   ↓
loadAccounts() 构建请求参数
   ↓
GET /accounts?refresh_start_date=xxx&refresh_end_date=xxx
   ↓
db.get_accounts_by_filters() 执行SQL查询
   ↓
WHERE last_refresh_time >= ? AND last_refresh_time <= ?
   ↓
返回符合条件的账户列表
   ↓
前端显示筛选结果
```

---

## 数据格式

### 前端日期格式
- **输入格式**: `datetime-local` → `YYYY-MM-DDTHH:mm`
- **存储格式**: ISO 8601 → `2024-10-30T14:30:00.000Z`

### 后端日期格式
- **接收格式**: ISO 8601字符串
- **数据库格式**: ISO 8601字符串
- **比较方式**: 字符串直接比较（ISO格式支持）

### 示例
```javascript
// 前端datetime-local输入
"2024-10-30T14:30"

// 转换为ISO格式传给后端
"2024-10-30T14:30:00.000Z"

// 数据库查询
WHERE last_refresh_time >= '2024-10-30T14:30:00.000Z'
  AND last_refresh_time <= '2024-10-30T23:59:00.000Z'
```

---

## 更新文件清单

| 文件 | 更新类型 | 说明 |
|------|---------|------|
| `static/index.html` | 修改 | UI组件、JavaScript函数、全局变量 |
| `database.py` | 修改 | `get_accounts_by_filters()` 函数 |
| `main.py` | 修改 | `GET /accounts` 和 `POST /accounts/batch-refresh-tokens` 端点 |
| `docs/筛选功能优化说明.md` | 新增 | 本文档 |

---

## 兼容性说明

### 向后兼容

- ✅ 原有的筛选选项保持不变
- ✅ 原有的API参数继续有效
- ✅ 新增参数为可选参数，不影响现有功能

### 数据库兼容

- ✅ 无需数据库迁移
- ✅ 使用现有的 `last_refresh_time` 字段
- ✅ 日期格式保持ISO 8601标准

---

## 测试建议

### 功能测试

1. **基本筛选测试**
   - [ ] 测试"全部状态"选项
   - [ ] 测试"从未刷新"选项
   - [ ] 测试"刷新失败"选项
   - [ ] 测试"刷新成功"选项

2. **日期范围测试**
   - [ ] 测试选择"指定刷新条件"是否显示日期选择器
   - [ ] 测试默认日期是否为30天前到现在
   - [ ] 测试起始时间晚于截止时间的验证
   - [ ] 测试必填项验证

3. **组合筛选测试**
   - [ ] 测试邮箱搜索 + 日期范围
   - [ ] 测试标签搜索 + 日期范围
   - [ ] 测试三重组合筛选

4. **批量刷新测试**
   - [ ] 测试日期范围批量刷新
   - [ ] 测试确认对话框显示正确的时间范围
   - [ ] 测试批量刷新结果统计

### 边界测试

- [ ] 测试空数据库
- [ ] 测试单个账户
- [ ] 测试大量账户（1000+）
- [ ] 测试跨时区日期
- [ ] 测试无效日期格式

---

## 已知限制

1. **时间精度**：精确到分钟，不支持秒级筛选
2. **时区处理**：使用本地时间，转换为UTC存储
3. **历史数据**：只能筛选有刷新记录的账户，`last_refresh_time` 为 NULL 的账户不会出现在日期范围筛选结果中

---

## 未来优化方向

1. **快捷时间选择**
   - 添加"最近1小时"、"今天"、"本周"、"本月"快捷按钮
   - 一键设置常用时间范围

2. **时间范围预设**
   - 保存常用的时间范围设置
   - 快速切换预设的筛选条件

3. **更多筛选维度**
   - 按创建时间筛选
   - 按下次刷新时间筛选
   - 按刷新次数筛选

4. **可视化展示**
   - 时间轴展示刷新历史
   - 图表展示筛选结果分布

---

## 总结

本次优化主要实现了：

✅ **5个清晰的状态筛选选项**  
✅ **全新的日期时间范围筛选功能**  
✅ **智能的默认值和验证机制**  
✅ **前后端完整的日期范围支持**  
✅ **批量刷新支持日期范围**  
✅ **友好的用户交互体验**

这些改进使账户筛选更加灵活和精准，特别适合：
- 大量账户的精细化管理
- 特定时间段的账户验证
- 批量操作前的精准筛选

---

**更新完成时间**: 2024年10月30日  
**适用版本**: v2.1.0+  
**状态**: ✅ 已完成

